<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Panel</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;margin:0;padding:16px}
  table{width:100%;max-width:900px;margin:0 auto;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #334155;padding:8px}
  th{background:#10b981;color:#06261f}
  button{padding:6px 10px;border:0;border-radius:8px;background:#3b82f6;color:#fff;cursor:pointer;margin:2px}
  .danger{background:#ef4444}
  .topbar{margin-bottom:16px;padding:12px;background:#1e293b;border-radius:8px}
  select,input{padding:6px;margin:4px;border-radius:6px;border:1px solid #475569}
</style>
</head>
<body>
  <h2>üëë Owner Panel</h2>
  <div id="me">Memuat‚Ä¶</div>

  <!-- PANEL KONTROL -->
  <div class="topbar">
    <label>Cari Player: </label>
    <input type="text" id="searchBox" placeholder="Ketik username/email..." onkeyup="filterPlayers()"><br>
    <label>Pilih Player: </label>
    <select id="playerSelect"><option value="">-- pilih --</option></select><br>

    <input type="number" id="coinAmount" placeholder="Jumlah Coin" value="100">
    <button onclick="transferCoin()">üí∞ Kirim Coin</button>
    <button onclick="transferCoinAll()">üåç Kirim Coin ke Semua</button><br>

    <input type="number" id="levelAmount" placeholder="Level Baru" value="10">
    <button onclick="setLevel()">‚≠ê Set Level</button>
    <button onclick="setLevelAll()">üåç Set Level Semua</button>
  </div>

  <!-- LIST USER -->
  <table>
    <thead><tr><th>Username</th><th>Email</th><th>Lv</th><th>Coin</th><th>Aksi</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
  <p style="text-align:center;margin-top:12px"><button onclick="nav('game.html')">‚¨ÖÔ∏è Kembali</button></p>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const cfg={apiKey:"AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",authDomain:"tamagotchi-2be0c.firebaseapp.com",databaseURL:"https://tamagotchi-2be0c-default-rtdb.firebaseio.com",projectId:"tamagotchi-2be0c",storageBucket:"tamagotchi-2be0c.firebasestorage.app",messagingSenderId:"202052432703",appId:"1:202052432703:web:cb76b50e42149a2c92998a",measurementId:"G-TWGGSJRX26"};
    firebase.initializeApp(cfg); 
    const auth=firebase.auth(), db=firebase.database();
    
    const OWNER_EMAIL="ryanfendiwardana@gmail.com";   // GANTI
    const OWNER_UID  ="vNuT6n1TD2XSjkywNbE5mROL8sa2"; // GANTI

    let players={};

    function nav(p){ location.href=p; }

    function render(snap){
      const tb=document.getElementById('rows'); 
      const sel=document.getElementById('playerSelect'); 
      tb.innerHTML='';
      sel.innerHTML='<option value="">-- pilih --</option>'; // reset isi

      players = {};
      snap.forEach(ch=>{
        const u=ch.val(), id=ch.key;
        players[id]=u;

        // Tambah ke tabel
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${u.username||'-'}</td>
          <td>${u.email||'-'}</td>
          <td>${u.level||1}</td>
          <td>${Number(u.coins||0).toFixed(2)}</td>
          <td>
            <button onclick="topup('${id}',100)">+100</button>
            <button onclick="reset('${id}')" class="danger">Reset</button>
          </td>`;
        tb.appendChild(tr);

        // Tambah ke dropdown
        const opt=document.createElement("option");
        opt.value=id; 
        opt.textContent=u.username || u.email || ("UID:"+id);
        sel.appendChild(opt);
      });
    }

    function filterPlayers(){
      const keyword=document.getElementById("searchBox").value.toLowerCase();
      const sel=document.getElementById("playerSelect");
      sel.innerHTML='<option value="">-- pilih --</option>'; 

      Object.entries(players).forEach(([id,u])=>{
        const label=(u.username||'')+" "+(u.email||'');
        if(label.toLowerCase().includes(keyword)){
          const opt=document.createElement("option");
          opt.value=id;
          opt.textContent=u.username || u.email || ("UID:"+id);
          sel.appendChild(opt);
        }
      });
    }

    function topup(id, amt){
      db.ref('users/'+id+'/coins').transaction(c=>(Number(c)||0)+amt);
    }
    function reset(id){
      if(!confirm('Reset user ini?')) return;
      db.ref('users/'+id).update({level:1,hunger:100,energy:100,hp:100,coins:0});
    }

    function transferCoin(){
      const id=document.getElementById("playerSelect").value;
      const amt=parseFloat(document.getElementById("coinAmount").value)||0;
      if(!id||amt<=0) return alert("Pilih player & isi jumlah coin");
      db.ref("users/"+id+"/coins").transaction(c=>(Number(c)||0)+amt);
      alert("‚úÖ Coin berhasil dikirim");
    }

    function setLevel(){
      const id=document.getElementById("playerSelect").value;
      const lvl=parseInt(document.getElementById("levelAmount").value)||1;
      if(!id||lvl<1) return alert("Pilih player & isi level valid");
      db.ref("users/"+id+"/level").set(lvl);
      alert("‚úÖ Level berhasil diubah");
    }

    function transferCoinAll(){
      const amt=parseFloat(document.getElementById("coinAmount").value)||0;
      if(amt<=0) return alert("Isi jumlah coin dulu");
      Object.keys(players).forEach(id=>{
        db.ref("users/"+id+"/coins").transaction(c=>(Number(c)||0)+amt);
      });
      alert("‚úÖ Coin berhasil dikirim ke semua player");
    }

    function setLevelAll(){
      const lvl=parseInt(document.getElementById("levelAmount").value)||1;
      if(lvl<1) return alert("Isi level valid dulu");
      Object.keys(players).forEach(id=>{
        db.ref("users/"+id+"/level").set(lvl);
      });
      alert("‚úÖ Level semua player berhasil diubah");
    }

    auth.onAuthStateChanged(u=>{
      if(!u){ location.href='index.html'; return; }
      if(u.email!==OWNER_EMAIL || u.uid!==OWNER_UID){
        alert('Bukan owner'); nav('game.html'); return;
      }
      document.getElementById('me').textContent=`Login sebagai ${u.email}`;
      db.ref('users').on('value',render);
    });
  </script>
</body>
</html>
