<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamagotchi ‚Äî Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;margin:0;padding:16px;text-align:center}
  header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px}
  .btn{background:#10b981;border:0;color:#06261f;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .1s}
  .btn:active{transform:scale(.95)}
  .ghost{background:#1e293b;color:#cde;border:1px solid #334155}
  #hud{margin:10px auto;max-width:720px;background:#101a2b;border-radius:12px;padding:10px}
  #bars{display:flex;gap:8px;justify-content:center}
  .bar{flex:1;background:#1f2937;border-radius:999px;overflow:hidden;border:1px solid #334155;position:relative;height:16px}
  .bar>div{height:100%;width:100%;transition:width .5s}
  .bar span{position:absolute;width:100%;text-align:center;font-size:11px;line-height:16px;color:#fff}
  #bh{background:#f87171}
  #be{background:#60a5fa}
  #bhp{background:#34d399}
  canvas{background:#08121a;border-radius:12px;margin:8px auto;image-rendering:pixelated;width:320px;height:320px}
  .grid{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:6px}
  .coinFx{position:absolute;font-size:14px;color:gold;pointer-events:none;animation:rise 1s ease-out forwards}
  @keyframes rise{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-40px)}}
</style>
</head>
<body>
  <header>
    <button class="btn ghost" onclick="nav('index.html')">‚üµ Keluar</button>
    <div id="who">Memuat‚Ä¶</div>
    <div class="grid">
      <button class="btn ghost" onclick="nav('inventory.html')">üì¶ Inventory</button>
      <button class="btn ghost" onclick="nav('marketplace.html')">üè™ Marketplace</button>
      <button class="btn ghost" onclick="nav('leaderboard.html')">üèÜ Leaderboard</button>
      <button class="btn ghost" onclick="nav('chat.html')">üí¨ Chat</button>
      <button id="soundBtn" class="btn ghost" onclick="toggleSound()">üîä</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <canvas id="cv" width="128" height="128"></canvas>

  <div id="hud">
    <div id="stats">Coin 0 ‚Ä¢ Lv 1</div>
    <div id="bars">
      <div class="bar"><div id="bh"></div><span id="bh_t"></span></div>
      <div class="bar"><div id="be"></div><span id="be_t"></span></div>
      <div class="bar"><div id="bhp"></div><span id="bhp_t"></span></div>
    </div>
    <div class="grid">
      <button class="btn" onclick="feed()">üçé Feed (1)</button>
      <button class="btn" onclick="sleep()">üí§ Sleep (1)</button>
      <button class="btn" id="tapBtn">üí∞ Tap +0.01</button>
      <button class="btn" onclick="levelUp()">‚¨ÜÔ∏è Level +1 (100)</button>
      <button class="btn" onclick="buyPet()">üõí Pet Baru (200)</button>
    </div>
  </div>

  <!-- Suara coin -->
  <audio id="coinSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c4b6ce1fa7.mp3?filename=coin-collect-retro-8-bit-sound-effect-145251.mp3" preload="auto"></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",authDomain:"tamagotchi-2be0c.firebaseapp.com",databaseURL:"https://tamagotchi-2be0c-default-rtdb.firebaseio.com",projectId:"tamagotchi-2be0c",storageBucket:"tamagotchi-2be0c.firebasestorage.app",messagingSenderId:"202052432703",appId:"1:202052432703:web:cb76b50e42149a2c92998a",measurementId:"G-TWGGSJRX26"};
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(),db=firebase.database();

    let me=null,uid=null,prof=null;
    const cv=document.getElementById("cv"),ctx=cv.getContext("2d");ctx.imageSmoothingEnabled=false;
    let t=0;

    function nav(p){location.href=p;}
    function logout(){auth.signOut().then(()=>location.href="index.html");}

    function def(){return{email:me.email,username:(prof&&prof.username)||"player",coins:50,level:1,hunger:100,energy:100,hp:100,currentPet:0,inventory:[{name:"Chick",level:1,kind:"egg"}],updatedAt:Date.now()};}
    function clamp(x,min,max){return Math.max(min,Math.min(max,x));}
    function pct(el,t,v){v=clamp(v,0,100);el.style.width=v+"%";t.textContent=v+"%";}

    const bh=document.getElementById("bh"),be=document.getElementById("be"),bhp=document.getElementById("bhp");
    const bh_t=document.getElementById("bh_t"),be_t=document.getElementById("be_t"),bhp_t=document.getElementById("bhp_t");

    function updateUI(){
      document.getElementById("who").textContent=`üë§ ${prof.username} (${me.email})`;
      document.getElementById("stats").textContent=`üí∞ ${Number(prof.coins).toFixed(2)} ‚Ä¢ Lv ${prof.level}`;
      pct(bh,bh_t,prof.hunger);pct(be,be_t,prof.energy);pct(bhp,bhp_t,prof.hp);
    }

    let saving=false;
    async function save(){if(!uid)return;if(saving)return;saving=true;prof.updatedAt=Date.now();await db.ref("users/"+uid).set(prof);saving=false;}

    function feed(){if(prof.coins<1)return alert("Coin tidak cukup");prof.coins-=1;prof.hunger=clamp(prof.hunger+10,0,100);save();updateUI();}
    function sleep(){if(prof.coins<1)return alert("Coin tidak cukup");prof.coins-=1;prof.energy=clamp(prof.energy+10,0,100);save();updateUI();}

    // --- SOUND ---
    const coinSound=document.getElementById("coinSound");
    let soundOn=true;
    function toggleSound(){
      soundOn=!soundOn;
      document.getElementById("soundBtn").textContent=soundOn?"üîä":"üîá";
    }
    function playCoinSound(){if(!soundOn)return;coinSound.currentTime=0;coinSound.play().catch(()=>{});}

    // --- TAP ---
    let lastTap=0;
    function tap(){
      const now=Date.now();if(now-lastTap<100)return;lastTap=now;
      prof.coins=Number((Number(prof.coins)+0.01).toFixed(2));
      save();updateUI();spawnCoinsFx();playCoinSound();
    }

    function spawnCoinsFx(){
      const fx=document.createElement("div");fx.className="coinFx";fx.textContent="+0.01";document.body.appendChild(fx);
      const btn=document.getElementById("tapBtn").getBoundingClientRect();
      fx.style.left=(btn.left+btn.width/2)+"px";fx.style.top=(btn.top-10)+"px";
      setTimeout(()=>fx.remove(),1000);
    }

    let tapInt=null;const tapBtn=document.getElementById("tapBtn");
    function startTapHold(){if(tapInt)return;tap();tapInt=setInterval(tap,200);}
    function stopTapHold(){if(tapInt){clearInterval(tapInt);tapInt=null;}}
    tapBtn.addEventListener("mousedown",startTapHold);
    tapBtn.addEventListener("mouseup",stopTapHold);
    tapBtn.addEventListener("mouseleave",stopTapHold);
    tapBtn.addEventListener("touchstart",e=>{e.preventDefault();startTapHold();},{passive:false});
    tapBtn.addEventListener("touchend",stopTapHold);
    tapBtn.addEventListener("touchcancel",stopTapHold);

    function levelUp(){if(prof.coins<100)return alert("Coin tidak cukup");prof.coins-=100;prof.level++;save();updateUI();}
    function buyPet(){if(prof.coins<200)return alert("Coin tidak cukup");prof.coins-=200;const pet={name:"Pet L"+prof.level,level:1,kind:"baby"+(1+Math.floor(Math.random()*3))};prof.inventory.push(pet);save();updateUI();alert("Pet baru masuk inventory!");}

    setInterval(()=>{if(!prof)return;prof.hunger=clamp(prof.hunger-1,0,100);prof.energy=clamp(prof.energy-1,0,100);if(prof.hunger===0||prof.energy===0){prof.hp=clamp(prof.hp-20,0,100);}if(prof.hp===0){alert("‚ò†Ô∏è Pet mati! Mulai dari Level 1 lagi.");prof.level=1;prof.hunger=100;prof.energy=100;prof.hp=100;prof.coins=0;}save();updateUI();},60000);

    function drawPet(){
      ctx.clearRect(0,0,cv.width,cv.height);
      for(let i=0;i<64;i++){ctx.fillStyle=i%2?"#0d1822":"#0b141d";ctx.fillRect((i*7+t)%128,(i*11)%128,3,3);}
      const x=44+Math.sin(t/10)*4,y=60+Math.cos(t/15)*2;
      if(prof.level<5){
        ctx.fillStyle="#ffd07a";ctx.fillRect(x,y,40,30);
        ctx.fillStyle="#111";ctx.fillRect(x+10,y+10,5,5);ctx.fillRect(x+25,y+10,5,5);
        ctx.fillStyle="#ff6b9a";ctx.fillRect(x+18,y+20,6,3);
      }else if(prof.level<10){
        ctx.fillStyle="#7ad0ff";ctx.fillRect(x-2,y-4,44,34);
        ctx.fillStyle="#7ad0ff";ctx.fillRect(x+4,y-10,6,8);ctx.fillRect(x+30,y-10,6,8);
        ctx.fillStyle="#111";ctx.fillRect(x+10,y+10,5,5);ctx.fillRect(x+27,y+10,5,5);
        ctx.fillStyle="#fff";ctx.fillRect(x+19,y+20,8,3);
      }else{
        ctx.fillStyle="#baff7a";ctx.fillRect(x-4,y-2,48,34);
        ctx.fillStyle="#88aaff";ctx.fillRect(x+40,y+8,10,8);ctx.fillRect(x+40,y+18,10,8);
        ctx.fillStyle="#111";ctx.fillRect(x+12,y+10,5,5);ctx.fillRect(x+30,y+10,5,5);
        ctx.fillStyle="#222";ctx.fillRect(x+20,y+22,8,3);
      }
      if(prof.hunger<20){ctx.fillStyle="#ff3b3b";ctx.fillRect(6,6,6,6);}
      if(prof.energy<20){ctx.fillStyle="#ffd23b";ctx.fillRect(16,6,6,6);}
      t++;requestAnimationFrame(drawPet);
    }

    auth.onAuthStateChanged(async u=>{if(!u){location.href="index.html";return;}me=u;uid=u.uid;const snap=await db.ref("users/"+uid).once("value");prof=snap.exists()?snap.val():def();if(!snap.exists())await save();updateUI();drawPet();});
  </script>
</body>
</html>
