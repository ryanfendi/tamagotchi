<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamagotchi â€” Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;margin:0;padding:16px;text-align:center}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .btn{background:#10b981;border:0;color:#06261f;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .ghost{background:#1e293b;color:#cde;border:1px solid #334155}
  #hud{margin:10px auto;max-width:720px;background:#101a2b;border-radius:12px;padding:10px}
  #bars{display:flex;gap:8px;justify-content:center}
  .bar{width:30%;background:#1f2937;border-radius:999px;overflow:hidden;border:1px solid #334155}
  .bar>div{height:12px;background:#10b981}
  canvas{background:#08121a;border-radius:12px;margin:8px auto;image-rendering:pixelated;width:320px;height:320px}
  .grid{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:6px}
</style>
</head>
<body>
  <header>
    <button class="btn ghost" onclick="nav('index.html')">âŸµ Keluar</button>
    <div id="who">Memuatâ€¦</div>
    <div class="grid">
      <button class="btn ghost" onclick="nav('inventory.html')">ğŸ“¦ Inventory</button>
      <button class="btn ghost" onclick="nav('marketplace.html')">ğŸª Marketplace</button>
      <button class="btn ghost" onclick="nav('leaderboard.html')">ğŸ† Leaderboard</button>
      <button class="btn ghost" onclick="nav('chat.html')">ğŸ’¬ Chat</button>
      <button class="btn" onclick="nav('owner.html')">ğŸ‘‘ Owner</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <canvas id="cv" width="128" height="128"></canvas>

  <div id="hud">
    <div id="stats">Coin 0 â€¢ Lv 1</div>
    <div id="bars">
      <div class="bar"><div id="bh"></div></div>
      <div class="bar"><div id="be"></div></div>
      <div class="bar"><div id="bhp"></div></div>
    </div>
    <div class="grid">
      <button class="btn" onclick="feed()">ğŸ Feed (1)</button>
      <button class="btn" onclick="sleep()">ğŸ’¤ Sleep (1)</button>
      <button class="btn" onclick="tap()">ğŸ’° Tap +0.01</button>
      <button class="btn" onclick="levelUp()">â¬†ï¸ Level +1 (100)</button>
      <button class="btn" onclick="buyPet()">ğŸ›’ Pet Baru (200)</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(), db=firebase.database();

    let me=null, uid=null, prof=null;

    const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
    ctx.imageSmoothingEnabled=false;
    let t=0;

    function nav(p){ location.href=p; }
    function logout(){ auth.signOut().then(()=>location.href='index.html'); }

    // default profile (jaga2 kalau belum ada)
    function def(){ return {
      email: me.email, username: (prof&&prof.username)||'player',
      coins: 50, level: 1, hunger: 100, energy: 100, hp: 100,
      currentPet: 0, inventory: [{name:'Chick', level:1, kind:'egg'}], updatedAt: Date.now()
    };}

    function clamp(x,min,max){ return Math.max(min, Math.min(max,x)); }
    function pct(el, v){ el.style.width = clamp(v,0,100)+'%'; }

    // BAR refs
    const bh=document.getElementById('bh');
    const be=document.getElementById('be');
    const bhp=document.getElementById('bhp');

    function updateUI(){
      document.getElementById('who').textContent = `ğŸ‘¤ ${prof.username} (${me.email})`;
      document.getElementById('stats').textContent = `ğŸ’° ${Number(prof.coins).toFixed(2)} â€¢ Lv ${prof.level}`;
      pct(bh, prof.hunger); pct(be, prof.energy); pct(bhp, prof.hp);
    }

    // SAVE
    let saving=false;
    async function save(){ if(!uid) return;
      if(saving) return; saving=true;
      prof.updatedAt = Date.now();
      await db.ref('users/'+uid).set(prof);
      saving=false;
    }

    // ACTIONS
    function feed(){
      if(prof.coins<1) return alert('Coin tidak cukup');
      prof.coins-=1; prof.hunger=clamp(prof.hunger+10,0,100); save(); updateUI();
    }
    function sleep(){
      if(prof.coins<1) return alert('Coin tidak cukup');
      prof.coins-=1; prof.energy=clamp(prof.energy+10,0,100); save(); updateUI();
    }
    function tap(){ prof.coins = Number((Number(prof.coins)+0.01).toFixed(2)); save(); updateUI(); }
    function levelUp(){
      if(prof.coins<100) return alert('Coin tidak cukup');
      prof.coins-=100; prof.level++; save(); updateUI();
    }
    function buyPet(){
      if(prof.coins<200) return alert('Coin tidak cukup');
      prof.coins-=200;
      const pet = {name:'Pet L'+prof.level, level:1, kind:'baby'+(1+Math.floor(Math.random()*3))};
      prof.inventory.push(pet);
      save(); updateUI(); alert('Pet baru masuk inventory!');
    }

    // DECAY per menit
    setInterval(()=>{
      if(!prof) return;
      prof.hunger = clamp(prof.hunger-1,0,100);
      prof.energy = clamp(prof.energy-1,0,100);
      if(prof.hunger===0 || prof.energy===0){
        prof.hp = clamp(prof.hp-20,0,100);
      }
      if(prof.hp===0){
        alert('â˜ ï¸ Pet mati! Mulai dari Level 1 lagi.');
        prof.level=1; prof.hunger=100; prof.energy=100; prof.hp=100; prof.coins=0;
      }
      save(); updateUI();
    }, 60000);

    // PIXEL PET (3 bentuk, berubah sesuai level)
    function drawPet(){
      ctx.clearRect(0,0,cv.width,cv.height);
      // background dots
      for(let i=0;i<64;i++){
        ctx.fillStyle = i%2? '#0d1822' : '#0b141d';
        ctx.fillRect((i*7+t)%128, (i*11)%128, 3,3);
      }
      const x=44+Math.sin(t/10)*4, y=60+Math.cos(t/15)*2;

      if(prof.level<5){
        // bayi bulat kuning
        ctx.fillStyle='#ffd07a'; ctx.fillRect(x,y,40,30);
        ctx.fillStyle='#111'; ctx.fillRect(x+10,y+10,5,5); ctx.fillRect(x+25,y+10,5,5);
        ctx.fillStyle='#ff6b9a'; ctx.fillRect(x+18,y+20,6,3);
      }else if(prof.level<10){
        // remaja dengan telinga kecil
        ctx.fillStyle='#7ad0ff'; ctx.fillRect(x-2,y-4,44,34);
        ctx.fillStyle='#7ad0ff'; ctx.fillRect(x+4,y-10,6,8); ctx.fillRect(x+30,y-10,6,8);
        ctx.fillStyle='#111'; ctx.fillRect(x+10,y+10,5,5); ctx.fillRect(x+27,y+10,5,5);
        ctx.fillStyle='#fff'; ctx.fillRect(x+19,y+20,8,3);
      }else{
        // dewasa bersayap
        ctx.fillStyle='#baff7a'; ctx.fillRect(x-4,y-2,48,34);
        ctx.fillStyle='#88aaff'; ctx.fillRect(x+40,y+8,10,8); ctx.fillRect(x+40,y+18,10,8);
        ctx.fillStyle='#111'; ctx.fillRect(x+12,y+10,5,5); ctx.fillRect(x+30,y+10,5,5);
        ctx.fillStyle='#222'; ctx.fillRect(x+20,y+22,8,3);
      }

      // indikator lapar/energi
      if(prof.hunger<20){ ctx.fillStyle='#ff3b3b'; ctx.fillRect(6,6,6,6); }
      if(prof.energy<20){ ctx.fillStyle='#ffd23b'; ctx.fillRect(16,6,6,6); }

      t++; requestAnimationFrame(drawPet);
    }

    // Auth & load
    auth.onAuthStateChanged(async u=>{
      if(!u){ location.href='index.html'; return; }
      me=u; uid=u.uid;
      const snap=await db.ref('users/'+uid).once('value');
      prof = snap.exists()? snap.val() : def();
      if(!snap.exists()) await save();
      updateUI(); drawPet();
    });
  </script>
</body>
</html>
