<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamagotchi ‚Äî Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;margin:0;padding:16px;text-align:center}
  header{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:10px}
  .menu{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
  .btn{background:#10b981;border:0;color:#06261f;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;transition:0.2s}
  .btn:hover{transform:scale(1.05)}
  .ghost{background:#1e293b;color:#cde;border:1px solid #334155}
  #hud{margin:10px auto;max-width:720px;background:#101a2b;border-radius:12px;padding:10px}
  #bars{display:flex;gap:8px;justify-content:center;margin:8px 0}
  .bar{flex:1;background:#1f2937;border-radius:999px;overflow:hidden;border:1px solid #334155;position:relative;height:14px}
  .bar>div{height:100%;width:0%;transition:width 0.5s}
  #bh{background:#f87171}
  #be{background:#60a5fa}
  #bhp{background:#34d399}
  .percent{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:12px;color:#ccc}
  canvas{background:#08121a;border-radius:12px;margin:8px auto;image-rendering:pixelated;width:320px;height:320px;display:block}
  .grid{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:6px}
  .coin-pop{position:absolute;font-size:14px;color:#ffd700;pointer-events:none;animation:pop 1s ease-out forwards}
  @keyframes pop{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-40px) scale(1.5)}}
</style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;width:100%;max-width:720px">
      <button class="btn ghost" onclick="nav('login.html')">‚üµ Keluar</button>
      <div id="who">Memuat‚Ä¶</div>
    </div>
    <div class="menu">
      <button class="btn ghost" onclick="nav('inventory.html')">üì¶ Inventory</button>
      <button class="btn ghost" onclick="nav('marketplace.html')">üè™ Marketplace</button>
      <button class="btn ghost" onclick="nav('leaderboard.html')">üèÜ Leaderboard</button>
      <button class="btn ghost" onclick="nav('chat.html')">üí¨ Chat</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <canvas id="cv" width="128" height="128"></canvas>

  <div id="hud">
    <div id="stats">Coin 0 ‚Ä¢ Lv 1</div>
    <div id="bars">
      <div class="bar"><div id="bh"></div><span id="ph" class="percent">0%</span></div>
      <div class="bar"><div id="be"></div><span id="pe" class="percent">0%</span></div>
      <div class="bar"><div id="bhp"></div><span id="php" class="percent">0%</span></div>
    </div>
    <div class="grid">
      <button class="btn" onclick="feed()">üçé Feed (1)</button>
      <button class="btn" onclick="sleep()">üí§ Sleep (1)</button>
      <button class="btn" id="tapBtn">üí∞ Tap +0.01</button>
      <button class="btn" onclick="levelUp()">‚¨ÜÔ∏è Level +1 (100)</button>
      <button class="btn" onclick="buyPet()">üõí Pet Baru (200)</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(), db=firebase.database();

    let me=null, uid=null, prof=null;

    const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
    ctx.imageSmoothingEnabled=false;
    let t=0;

    function nav(p){ location.href=p; }
    function logout(){ auth.signOut().then(()=>location.href='login.html'); }

    function def(){ return {
      email: me.email, username: (prof&&prof.username)||'player',
      coins: 50, level: 1, hunger: 100, energy: 100, hp: 100,
      currentPet: 0, inventory: [{name:'Chick', level:1, kind:'egg'}], updatedAt: Date.now()
    };}

    function clamp(x,min,max){ return Math.max(min, Math.min(max,x)); }
    function pct(el, v, pe){ el.style.width = clamp(v,0,100)+'%'; pe.textContent = clamp(v,0,100)+'%'; }

    const bh=document.getElementById('bh');
    const be=document.getElementById('be');
    const bhp=document.getElementById('bhp');
    const ph=document.getElementById('ph');
    const pe=document.getElementById('pe');
    const php=document.getElementById('php');

    function updateUI(){
      document.getElementById('who').textContent = `üë§ ${prof.username} (${me.email})`;
      document.getElementById('stats').textContent = `üí∞ ${Number(prof.coins).toFixed(2)} ‚Ä¢ Lv ${prof.level}`;
      pct(bh, prof.hunger, ph); pct(be, prof.energy, pe); pct(bhp, prof.hp, php);
    }

    let saving=false;
    async function save(){ if(!uid) return;
      if(saving) return; saving=true;
      prof.updatedAt = Date.now();
      await db.ref('users/'+uid).set(prof);
      saving=false;
    }

    function feed(){
      if(prof.coins<1) return alert('Coin tidak cukup');
      prof.coins-=1; prof.hunger=clamp(prof.hunger+10,0,100); save(); updateUI();
    }
    function sleep(){
      if(prof.coins<1) return alert('Coin tidak cukup');
      prof.coins-=1; prof.energy=clamp(prof.energy+10,0,100); save(); updateUI();
    }

    function tap(){ 
      prof.coins = Number((Number(prof.coins)+0.01).toFixed(2)); 
      save(); updateUI(); 
      spawnCoinEffect(); 
    }

    function levelUp(){
      if(prof.coins<100) return alert('Coin tidak cukup');
      prof.coins-=100; prof.level++; save(); updateUI();
    }
    function buyPet(){
      if(prof.coins<200) return alert('Coin tidak cukup');
      prof.coins-=200;
      const pet = {name:'Pet L'+prof.level, level:1, kind:'baby'+(1+Math.floor(Math.random()*3))};
      prof.inventory.push(pet);
      save(); updateUI(); alert('Pet baru masuk inventory!');
    }

    setInterval(()=>{
      if(!prof) return;
      prof.hunger = clamp(prof.hunger-1,0,100);
      prof.energy = clamp(prof.energy-1,0,100);
      if(prof.hunger===0 || prof.energy===0){
        prof.hp = clamp(prof.hp-20,0,100);
      }
      if(prof.hp===0){
        alert('‚ò†Ô∏è Pet mati! Mulai dari Level 1 lagi.');
        prof.level=1; prof.hunger=100; prof.energy=100; prof.hp=100; prof.coins=0;
      }
      save(); updateUI();
    }, 60000);

    function drawPet(){
      ctx.clearRect(0,0,cv.width,cv.height);
      for(let i=0;i<64;i++){
        ctx.fillStyle = i%2? '#0d1822' : '#0b141d';
        ctx.fillRect((i*7+t)%128, (i*11)%128, 3,3);
      }
      const x=44+Math.sin(t/10)*4, y=60+Math.cos(t/15)*2;

      if(prof.level<5){
        ctx.fillStyle='#ffd07a'; ctx.fillRect(x,y,40,30);
        ctx.fillStyle='#111'; ctx.fillRect(x+10,y+10,5,5); ctx.fillRect(x+25,y+10,5,5);
        ctx.fillStyle='#ff6b9a'; ctx.fillRect(x+18,y+20,6,3);
      }else if(prof.level<10){
        ctx.fillStyle='#7ad0ff'; ctx.fillRect(x-2,y-4,44,34);
        ctx.fillStyle='#7ad0ff'; ctx.fillRect(x+4,y-10,6,8); ctx.fillRect(x+30,y-10,6,8);
        ctx.fillStyle='#111'; ctx.fillRect(x+10,y+10,5,5); ctx.fillRect(x+27,y+10,5,5);
        ctx.fillStyle='#fff'; ctx.fillRect(x+19,y+20,8,3);
      }else{
        ctx.fillStyle='#baff7a'; ctx.fillRect(x-4,y-2,48,34);
        ctx.fillStyle='#88aaff'; ctx.fillRect(x+40,y+8,10,8); ctx.fillRect(x+40,y+18,10,8);
        ctx.fillStyle='#111'; ctx.fillRect(x+12,y+10,5,5); ctx.fillRect(x+30,y+10,5,5);
        ctx.fillStyle='#222'; ctx.fillRect(x+20,y+22,8,3);
      }

      if(prof.hunger<20){ ctx.fillStyle='#ff3b3b'; ctx.fillRect(6,6,6,6); }
      if(prof.energy<20){ ctx.fillStyle='#ffd23b'; ctx.fillRect(16,6,6,6); }

      t++; requestAnimationFrame(drawPet);
    }

    function spawnCoinEffect(){
      const el=document.createElement("div");
      el.className="coin-pop";
      el.textContent="+0.01";
      const btn=document.getElementById("tapBtn");
      const rect=btn.getBoundingClientRect();
      el.style.left=(rect.left+rect.width/2)+"px";
      el.style.top=(rect.top-10)+"px";
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),1000);
    }

    // fix tap+hold bug ‚Üí hanya sekali per klik/touch
    const tapBtn=document.getElementById("tapBtn");
    tapBtn.addEventListener("click", tap);
    tapBtn.addEventListener("touchend", e=>{ e.preventDefault(); tap(); }, {passive:false});

    auth.onAuthStateChanged(async u=>{
      if(!u){ location.href='login.html'; return; }
      me=u; uid=u.uid;
      const snap=await db.ref('users/'+uid).once('value');
      prof = snap.exists()? snap.val() : def();
      if(!snap.exists()) await save();
      updateUI(); drawPet();
    });
  </script>
</body>
</html>
