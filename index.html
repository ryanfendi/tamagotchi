<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamagotchi Pixel ‚Äî Ekspresi & Animasi</title>
<style>
  :root{--bg:#0b1220;--card:#0f1724;--accent:#10b981;--muted:#9fb3b5}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071726,#06202a);font-family:system-ui,Arial;color:#e6eef6}
  .wrap{max-width:920px;margin:18px auto;display:grid;grid-template-columns:520px 1fr;gap:18px;padding:16px}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
  h1{margin:0 0 8px;font-size:20px}
  canvas{background:#08121a;border-radius:8px;display:block;margin:12px auto;image-rendering:pixelated}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  button{background:linear-gradient(180deg,var(--accent),#06a77a);border:0;color:#042018;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  button.alt{background:linear-gradient(180deg,#06b6d4,#0891b2);color:#042018}
  .small{font-size:13px;color:var(--muted)}
  label.inline{display:flex;gap:8px;align-items:center}
  input[type=text]{padding:6px;border-radius:6px;border:0}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>üê£ Tamagotchi Pixel ‚Äî Animasi & Ekspresi</h1>
    <div style="text-align:center">
      <canvas id="canvas" width="128" height="128" style="width:320px;height:320px"></canvas>
    </div>

    <div class="controls">
      <input id="nameInput" type="text" placeholder="Nama pemain"/>
      <button id="startBtn">Start / Login</button>
      <label class="inline"><input id="devChk" type="checkbox"> DEV_MODE</label>
    </div>

    <div class="controls" style="margin-top:8px">
      <button id="feedBtn" class="alt">üçé Feed</button>
      <button id="sleepBtn">üí§ Sleep</button>
      <button id="resetBtn">üîÅ Reset</button>
    </div>

    <div class="small" style="display:flex;justify-content:space-between;margin-top:10px">
      <div>Status: <span id="statusText">‚Äî</span></div>
      <div>Last feed: <span id="lastFeedText">‚Äî</span></div>
    </div>

    <div class="small" id="log" style="margin-top:10px;min-height:30px"></div>

    <div class="small" style="margin-top:8px">
      Aturan: makan tiap <strong>4 jam</strong> (DEV: 1 menit), minimal <strong>3x/hari</strong> atau pet mati. Evolusi tiap hari.
    </div>
  </div>

  <div class="panel">
    <h2 style="margin:0 0 8px">‚ÑπÔ∏è Catatan</h2>
    <div class="small">
      Versi ini fokus memperbaiki <em>karakter tidak bergerak & ekspresi</em> dengan sprite 16√ó16,
      animasi jalan, goyang, lompat, dan kedip. Marketplace online bisa ditambahkan lagi setelah ini.
    </div>
  </div>
</div>

<script>
/* =========================================================
   TIMING
========================================================= */
const MS_HOUR = 3600_000;
const DEFAULTS   = { FEED_INTERVAL_MS: 4*MS_HOUR, DAY_MS: 24*MS_HOUR, WEEK_MS: 7*24*MS_HOUR };
const DEV_DEFAULTS = { FEED_INTERVAL_MS: 60_000,   DAY_MS: 30_000,    WEEK_MS: 7*30_000 };

let T = DEFAULTS;

/* =========================================================
   STORAGE (local)
========================================================= */
const KEY = 'tama_pixel_v1';
function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'null')}catch{ return null } }
function save(v){ try{localStorage.setItem(KEY, JSON.stringify(v))}catch{} }

/* =========================================================
   DOM
========================================================= */
const CANVAS = document.getElementById('canvas');
const CTX = CANVAS.getContext('2d'); CTX.imageSmoothingEnabled = false;
const nameInput = document.getElementById('nameInput');
const startBtn = document.getElementById('startBtn');
const devChk   = document.getElementById('devChk');
const feedBtn  = document.getElementById('feedBtn');
const sleepBtn = document.getElementById('sleepBtn');
const resetBtn = document.getElementById('resetBtn');
const statusText = document.getElementById('statusText');
const lastFeedText = document.getElementById('lastFeedText');
const logEl = document.getElementById('log');

/* =========================================================
   MODEL
========================================================= */
function makePlayer(name){
  const now = Date.now();
  return {
    name,
    createdAt: now,
    lastDailyChecked: dateStr(now),
    pet: {
      alive:true,
      sleeping:false,
      evoIndex:0,
      ageDays:0,
      lastFeed:null,
      feedTimestamps:[],
    }
  };
}
let state = load() || { players:{} , current:null };

function ensurePlayer(n){
  if(!state.players[n]) state.players[n]=makePlayer(n);
  state.current = n; save(state);
}

/* =========================================================
   UTIL
========================================================= */
function dateStr(ts){ const d=new Date(ts); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}` }
function msToStr(ms){ if(ms<=0)return'0s';const s=(ms/1000)|0,h=(s/3600)|0,m=((s%3600)/60)|0,sc=s%60; if(h)return`${h}h ${m}m`; if(m)return`${m}m ${sc}s`; return`${sc}s`; }
function log(msg){ const t=(new Date()).toLocaleTimeString(); logEl.innerHTML = `[${t}] ${msg}<br>` + logEl.innerHTML }

/* =========================================================
   PIXEL SPRITES (16√ó16). Kode warna:
   0=transparan, 1=outline, 2=body, 3=eye, 4=mouth, 5=highlight,
   6=angry mark, 7=sleep aura, 8=sick blush
========================================================= */
const PAL = {
  0:"#00000000", 1:"#2b2f3a", 2:"#ffe38a", 3:"#0e1015", 4:"#f58a8a",
  5:"#fff3a6", 6:"#ff5252", 7:"#3bd4cf", 8:"#44c04b"
};
function evoBodyColor(e){ if(e<2) return "#ffe38a"; if(e<5) return "#7dff7a"; return "#77c8ff"; }

// tubuh oval 16x16 (1 outline, 2 body)
const BODY = [
"0000111111110000",
"0001222222221000",
"0012222222222100",
"0122222222222210",
"1222222222222221",
"1222222222222221",
"1222222222222221",
"1222222222222221",
"1222222222222221",
"1222222222222221",
"1222222222222221",
"0122222222222210",
"0012222222222100",
"0001222222221000",
"0000111111110000",
"0000000000000000",
];

// wajah (mata/mulut) per ekspresi
const FACE = {
  idle: [
"0000000000000000","0000000000000000",
"0000030003000000","0000000000000000",
"0000004400000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
  happy: [
"0000000000000000","0000000000000000",
"0000030003000000","0000000000000000",
"0000004400000000","0000005500000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
  sad: [
"0000000000000000","0000000000000000",
"0000030003000000","0000000000000000",
"0000000000000000","0000440000440000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
  angry: [
"0000300000030000","0003000000003000",
"0000000000000000","0000000000000000",
"0000004400000000","0000004400000000",
"0000600000000060","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
  sleep: [
"0000000000000000","0000077777700000",
"0000070000700000","0000077777700000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
  sick: [
"0000000000000000","0000000000000000",
"0000030003000000","0000000000000000",
"0000088800888000","0000004400000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
  blink: [
"0000000000000000","0000000000000000",
"0000000000000000","0000333333330000",
"0000004400000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
"0000000000000000","0000000000000000",
  ],
};

// gabungkan BODY + FACE -> grid final
function compose(evo, expr){
  const body = BODY.map(r=>r.split(""));
  const face = (FACE[expr]||FACE.idle).map(r=>r.split(""));
  const out = [];
  const bodyCol = evoBodyColor(evo);
  for(let y=0;y<16;y++){
    const row=[];
    for(let x=0;x<16;x++){
      const b = body[y][x];
      const f = face[y][x];
      if(b==="0" && f==="0"){ row.push({c:PAL[0]}); continue; }
      if(b==="1"){ row.push({c:PAL[1]}); continue; }
      if(b==="2"){ row.push({c:bodyCol}); continue; }
      // face
      const col = PAL[f] || PAL[0];
      row.push({c:col});
    }
    out.push(row);
  }
  return out;
}

// gambar grid 16√ó16 -> canvas 128√ó128 (8x)
function drawGrid(grid, offsetX=0, offsetY=0){
  const px=8;
  for(let y=0;y<16;y++){
    for(let x=0;x<16;x++){
      const col = grid[y][x].c;
      if(col==="transparent" || col==="#00000000") continue;
      CTX.fillStyle = col;
      CTX.fillRect(x*px+offsetX, y*px+offsetY, px, px);
    }
  }
}

/* =========================================================
   MOOD ENGINE (auto)
========================================================= */
function pickMood(pet){
  if(!pet || !pet.alive) return "sad";
  if(pet.sleeping) return "sleep";
  const now = Date.now();
  const since = pet.lastFeed ? now - pet.lastFeed : Infinity;

  // ambang
  if (since > 12*MS_HOUR) return "sick";
  if (since > 8*MS_HOUR)  return "sad";
  if (since > 4*MS_HOUR)  return "hungry"; // akan fallback ke idle/happy visual (mulut kecil)
  return "happy";
}

/* =========================================================
   GAME LOOP & RULES
========================================================= */
let blinkTimer=0, frame=0, walkPhase=0, jumpT=0, angryFlag=false;

function draw(){
  CTX.clearRect(0,0,128,128);
  // BG
  CTX.fillStyle = "#08121a"; CTX.fillRect(0,0,128,128);

  const p = state.current ? state.players[state.current] : null;
  if(!p || !p.pet){
    CTX.fillStyle="#9fb3b5"; CTX.font="10px monospace";
    CTX.fillText("Login untuk memulai", 18, 64);
    return;
  }

  // posisi animasi
  frame = (frame+1)%10000;
  walkPhase += 0.06; // kecepatan jalan L-R
  let ox = Math.round(Math.sin(walkPhase)*8); // -8..8
  let oy = Math.round(Math.sin(frame*0.2));   // bob

  // loncat setelah makan
  if (jumpT>0){
    const up = Math.sin((1-jumpT/20)*Math.PI)*10;
    oy -= up|0;
    jumpT--;
  }

  // mood + blink
  let mood = pickMood(p.pet);
  if (angryFlag) mood = "angry";
  blinkTimer = (blinkTimer+1)%180;
  const expr = (!p.pet.sleeping && blinkTimer<6) ? "blink" : mood;

  // gambar
  const grid = compose(p.pet.evoIndex||0, expr);
  drawGrid(grid, ox, oy);

  // highlight evo tinggi
  if((p.pet.evoIndex||0)>=5){
    CTX.fillStyle="#fff3a6";
    CTX.fillRect(6,6,3,3); CTX.fillRect(118,14,2,2);
  }
}

function dailyCheck(){
  const p = state.current ? state.players[state.current] : null;
  if(!p) return;
  const now = Date.now();
  const today = dateStr(now);
  if (p.lastDailyChecked !== today){
    // hitung makan kemarin
    const prevStart = new Date(new Date(now - T.DAY_MS).toDateString()).getTime();
    const prevEnd   = prevStart + T.DAY_MS;
    const feeds = (p.pet?.feedTimestamps||[]).filter(ts=> ts>=prevStart && ts<prevEnd).length;

    if (p.pet){
      if (feeds < 3){
        p.pet.alive = false;
        log(`‚ùå Mati: makan ${feeds}x kemarin`);
      } else {
        p.pet.ageDays = (p.pet.ageDays||0)+1;
        p.pet.evoIndex = Math.min(7, p.pet.ageDays);
        log(`‚úÖ Hari baru: survive (${feeds}x makan). age=${p.pet.ageDays}`);
      }
    }
    p.lastDailyChecked = today;
    save(state);
    updateUI();
  }
}

function updateUI(){
  const p = state.current ? state.players[state.current] : null;
  if(!p){ statusText.textContent='‚Äî'; lastFeedText.textContent='‚Äî'; return; }
  statusText.textContent = p.pet ? (p.pet.alive ? (p.pet.sleeping?'Sleep':'Hidup') : 'Mati') : 'No pet';
  lastFeedText.textContent = p.pet?.lastFeed ? new Date(p.pet.lastFeed).toLocaleString() : '‚Äî';
}

/* =========================================================
   EVENTS
========================================================= */
startBtn.onclick = () => {
  const n = (nameInput.value||'').trim();
  if(!n) { alert('Masukkan nama'); return; }
  T = devChk.checked ? DEV_DEFAULTS : DEFAULTS;
  ensurePlayer(n);
  updateUI();
};
resetBtn.onclick = () => {
  if(!state.current) return alert('Login dulu');
  if(!confirm('Reset pet?')) return;
  state.players[state.current] = makePlayer(state.current);
  save(state);
  log('Reset selesai');
  updateUI();
};
sleepBtn.onclick = () => {
  if(!state.current) return alert('Login dulu');
  const p = state.players[state.current];
  if(!p.pet) p.pet = makePlayer('tmp').pet; // guard
  p.pet.sleeping = !p.pet.sleeping;
  save(state);
  log(p.pet.sleeping?'üò¥ Tidur':'üåû Bangun');
  updateUI();
};

feedBtn.addEventListener('click', ()=>{
  if(!state.current) return alert('Login dulu');
  const p = state.players[state.current];
  if(!p.pet) p.pet = makePlayer('tmp').pet;
  if(!p.pet.alive) return alert('Pet mati. Reset dulu');

  const now=Date.now();
  const last = p.pet.lastFeed||0;
  const wait = T.FEED_INTERVAL_MS - (now-last);
  if (last && wait>0){
    angryFlag = true; setTimeout(()=>angryFlag=false, 1200);
    return alert('Terlalu cepat! tunggu '+msToStr(wait));
  }
  p.pet.lastFeed = now;
  p.pet.feedTimestamps.push(now);
  save(state);
  jumpT = 20; // anim lompat
  log('üçé Makan!');
  updateUI();
});

/* =========================================================
   LOOPS
========================================================= */
setInterval(draw, 1000/30); // 30 FPS animasi
setInterval(()=>{ dailyCheck(); updateUI(); }, 1000);

/* first paint */
updateUI();
draw();
</script>
</body>
</html>
