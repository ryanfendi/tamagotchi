<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tamagotchi ‚Äî Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  .wrap{max-width:760px;margin:0 auto;padding:10px}
  canvas{background:#08121a;border-radius:12px;image-rendering:pixelated;margin:10px auto;display:block}
  .btn{background:#10b981;border:0;color:#042018;font-weight:700;padding:10px 12px;border-radius:10px;margin:5px;cursor:pointer}
  .btn.gray{background:#1f2937;color:#fff}
  .row{margin:6px 0}
  input{padding:10px;border-radius:10px;border:0;margin:4px;width:260px;max-width:90%}
  .menu a,.menu button{display:inline-block;text-decoration:none}
  .hidden{display:none}
  .bars{max-width:360px;margin:6px auto}
  .bar{height:18px;background:#263245;border-radius:10px;margin:6px 0;overflow:hidden}
  .fill{height:100%}
  .hunger{background:#ef4444}
  .energy{background:#3b82f6}
  .hp{background:#10b981}
  small.mono{font-family:ui-monospace,Menlo,monospace;opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <h1>üê£ Tamagotchi Pixel Game</h1>

  <!-- LOGIN -->
  <div id="loginBox">
    <div class="row">
      <input id="loginId" placeholder="Username atau Email" />
    </div>
    <div class="row">
      <input id="loginPass" type="password" placeholder="Password" />
    </div>
    <div class="row">
      <button class="btn" onclick="doLogin()">Login</button>
    </div>
    <div class="row">
      <a class="btn gray" href="register.html">Daftar akun baru</a>
    </div>
    <p><small class="mono">Login sekali ‚Üí halaman lain otomatis mengenali akunmu.</small></p>
  </div>

  <!-- GAME UI -->
  <div id="gameUI" class="hidden">
    <div class="menu">
      <a class="btn gray" href="inventory.html">üì¶ Inventory</a>
      <a class="btn gray" href="marketplace.html">üè™ Marketplace</a>
      <a class="btn gray" href="leaderboard.html">üèÜ Leaderboard</a>
      <a class="btn gray" href="chat.html">üí¨ Chat</a>
      <button class="btn" onclick="logout()">üö™ Logout</button>
    </div>

    <p id="welcome"></p>

    <canvas id="cv" width="128" height="128" style="width:320px;height:320px"></canvas>

    <div class="bars">
      <div class="bar"><div id="barH" class="fill hunger" style="width:100%"></div></div>
      <div class="bar"><div id="barE" class="fill energy" style="width:100%"></div></div>
      <div class="bar"><div id="barHP" class="fill hp" style="width:100%"></div></div>
    </div>

    <div id="status"></div>
    <div id="coinInfo" style="margin:.35rem 0 1rem"></div>

    <div class="row">
      <button class="btn" onclick="buyFeed()">üçé Feed (+10%, 100c)</button>
      <button class="btn" onclick="buySleep()">üò¥ Sleep (+10%, 100c)</button>
    </div>
    <div class="row">
      <button class="btn" onclick="tapCoin()">üí∞ Tap Coin (+10)</button>
      <button class="btn" onclick="levelUpManual()">‚¨ÜÔ∏è Naik Level (100.000c)</button>
    </div>
    <p><small class="mono">Hunger & Energy -1%/menit. Jika keduanya 0% ‚Üí HP -20%/menit. HP=0 ‚Üí pet mati & reset Level 1.</small></p>
  </div>
</div>

<script>
/* ====== STORAGE & SESSION ====== */
let players = JSON.parse(localStorage.getItem('players')||'{}');
function savePlayers(){ localStorage.setItem('players', JSON.stringify(players)); }
function setSession(username){ localStorage.setItem('lastUser', username); }
function getSession(){ return localStorage.getItem('lastUser'); }
function clearSession(){ localStorage.removeItem('lastUser'); }

function getUserByLogin(id){
  id = (id||'').trim().toLowerCase();
  if(!id) return null;
  // Jika mengandung '@' ‚Üí anggap email
  if(id.includes('@')){
    const pair = Object.entries(players).find(([u,p]) => (p.email||'').toLowerCase()===id);
    return pair ? pair[0] : null;
  }
  // selain itu ‚Üí username
  return players[id] ? id : null;
}

function ensurePlayer(username, pass, email){
  if(!players[username]){
    players[username] = {
      username,
      email: email||'',
      password: pass,
      coins: 1000,
      pet: { level:1, hunger:100, energy:100, hp:100, alive:true, lastTick: Date.now() },
      inventory: []
    };
  }
}

/* ====== LOGIN / LOGOUT ====== */
let me = null;     // object player
let myName = null; // username

function doLogin(){
  const id = document.getElementById('loginId').value;
  const pass = (document.getElementById('loginPass').value||'').trim();
  if(!id||!pass) return alert('Isi username/email dan password.');

  const uname = getUserByLogin(id);
  if(!uname){
    // Auto-register cepat jika belum ada akun dengan ID tsb (username)
    if(id.includes('@')) return alert('Email belum terdaftar. Silakan daftar di halaman Register.');
    ensurePlayer(id.trim().toLowerCase(), pass, '');
    savePlayers();
    return proceedLogin(id.trim().toLowerCase(), pass);
  }
  // cek password
  if(players[uname].password !== pass) return alert('Username/Email atau password salah');
  proceedLogin(uname, pass);
}
function proceedLogin(uname){
  myName = uname;
  me = players[uname];
  setSession(uname);
  savePlayers();
  showGame();
}
function logout(){
  clearSession();
  location.href = 'index.html';
}

/* ====== AUTO LOGIN ====== */
(function auto(){
  const last = getSession();
  if(last && players[last]){
    myName = last; me = players[last];
    showGame();
  }
})();

/* ====== GAME UI ====== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
ctx.imageSmoothingEnabled = false;
let frame = 0;

function showGame(){
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('gameUI').classList.remove('hidden');
  document.getElementById('welcome').textContent = `Selamat datang, ${myName}!`;
  catchUpDecay();
  updateUI();
  loop();
}
function updateUI(){
  const p = me.pet;
  document.getElementById('barH').style.width = p.hunger + '%';
  document.getElementById('barE').style.width = p.energy + '%';
  document.getElementById('barHP').style.width = p.hp + '%';
  document.getElementById('status').textContent = `‚ù§Ô∏è HP ${p.hp}% ‚Ä¢ üçé Hunger ${p.hunger}% ‚Ä¢ üò¥ Energy ${p.energy}%`;
  document.getElementById('coinInfo').textContent = `üí∞ Coin: ${me.coins} ‚Ä¢ Level: ${p.level}`;
}

/* ====== MEKANIK ====== */
function buyFeed(){
  if(me.coins<100) return alert('Coin tidak cukup');
  me.coins -= 100;
  me.pet.hunger = Math.min(100, me.pet.hunger + 10);
  savePlayers(); updateUI();
}
function buySleep(){
  if(me.coins<100) return alert('Coin tidak cukup');
  me.coins -= 100;
  me.pet.energy = Math.min(100, me.pet.energy + 10);
  savePlayers(); updateUI();
}
function tapCoin(){ me.coins += 10; savePlayers(); updateUI(); }
function levelUpManual(){
  if(me.coins < 100000) return alert('Coin tidak cukup (butuh 100.000)');
  me.coins -= 100000;
  me.pet.level += 1;
  // bonus pulih
  me.pet.hunger = 100; me.pet.energy = 100; me.pet.hp = 100;
  savePlayers(); updateUI();
}

// Kurangi stat tiap menit, dan tangani kematian
function decayOneMinute(pet){
  pet.hunger = Math.max(0, pet.hunger - 1);
  pet.energy = Math.max(0, pet.energy - 1);
  if(pet.hunger===0 && pet.energy===0){
    pet.hp = Math.max(0, pet.hp - 20);
  }
  if(pet.hp<=0){
    // Mati ‚Üí reset
    alert('üíÄ Pet mati! Kembali ke Level 1.');
    me.pet = { level:1, hunger:100, energy:100, hp:100, alive:true, lastTick: Date.now() };
  }
}

// Catch-up kalau lama tidak buka halaman
function catchUpDecay(){
  const pet = me.pet;
  const now = Date.now();
  const last = pet.lastTick || now;
  const diffMin = Math.floor((now - last)/60000);
  if(diffMin>0){
    for(let i=0;i<diffMin;i++) decayOneMinute(pet);
    pet.lastTick = now;
    savePlayers();
  }
}

setInterval(()=>{
  if(!me) return;
  decayOneMinute(me.pet);
  me.pet.lastTick = Date.now();
  savePlayers(); updateUI();
}, 60000);

/* ====== SPRITE LUCu (evolusi) ======
   Tier: 1-4 bayi, 5-9 anak, 10-19 remaja, 20-49 dewasa, 50+ legendaris
*/
function drawPet(){
  const p = me.pet;
  ctx.clearRect(0,0,cv.width,cv.height);

  // background bintang
  ctx.fillStyle = '#08121a';
  ctx.fillRect(0,0,128,128);
  for(let i=0;i<18;i++){
    ctx.fillStyle = 'rgba(255,255,255,.12)';
    ctx.fillRect((i*13 + frame)%128, (i*7 + frame*0.8)%128, 1, 1);
  }

  let tier=0, body='#ffd07a';
  if(p.level<5){ tier=0; body='#ffd07a'; }
  else if(p.level<10){ tier=1; body='#93c5fd'; }
  else if(p.level<20){ tier=2; body='#34d399'; }
  else if(p.level<50){ tier=3; body='#f472b6'; }
  else { tier=4; body='#fbbf24'; }

  const wobX = Math.sin(frame/12)*3;
  const wobY = Math.cos(frame/18)*2;
  const baseX = 64 + wobX;
  const baseY = 70 + wobY;

  // gambar bentuk per tier
  ctx.fillStyle = body;

  if(tier===0){ // bayi: kotak mungil
    ctx.fillRect(baseX-14, baseY-12, 28, 22);
  } else if(tier===1){ // anak: bulat
    ctx.beginPath(); ctx.arc(baseX, baseY, 16, 0, Math.PI*2); ctx.fill();
  } else if(tier===2){ // remaja: persegi besar + topi kecil
    ctx.fillRect(baseX-18, baseY-16, 36, 30);
    ctx.fillStyle='#222'; ctx.fillRect(baseX-10, baseY-22, 20, 6);
    ctx.fillStyle=body;
  } else if(tier===3){ // dewasa: bulat besar + antena
    ctx.beginPath(); ctx.arc(baseX, baseY, 22, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#222'; ctx.fillRect(baseX-2, baseY-30, 4, 10);
    ctx.fillStyle=body; ctx.fillRect(baseX-3, baseY-34, 6, 4);
  } else { // legendaris: segitiga (naga kecil)
    ctx.beginPath(); ctx.moveTo(baseX, baseY-24); ctx.lineTo(baseX+24, baseY+20); ctx.lineTo(baseX-24, baseY+20); ctx.closePath(); ctx.fill();
    // sayap
    ctx.fillStyle='#fff';
    ctx.fillRect(baseX-28, baseY-2, 10, 4);
    ctx.fillRect(baseX+18, baseY-2, 10, 4);
    ctx.fillStyle=body;
  }

  // mata (berkedip)
  const blink = Math.floor(frame/50)%2===0;
  ctx.fillStyle = '#0b0b0b';
  if(blink){
    ctx.fillRect(baseX-6, baseY-2, 3, 3);
    ctx.fillRect(baseX+3, baseY-2, 3, 3);
  }else{
    ctx.fillRect(baseX-6, baseY-1, 3, 1);
    ctx.fillRect(baseX+3, baseY-1, 3, 1);
  }

  // mulut sesuai HP
  ctx.fillStyle = (p.hp>50)?'#fff':'#ff7b7b';
  ctx.fillRect(baseX-4, baseY+6, 8, 2);

  frame++;
}

function loop(){
  if(!me) return;
  drawPet();
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
