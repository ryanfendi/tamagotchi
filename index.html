<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamagotchi Pixel Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  canvas{background:#08121a;image-rendering:pixelated;border-radius:8px;margin-top:10px}
  .controls button{background:#10b981;border:none;padding:10px;margin:5px;border-radius:8px;font-weight:bold;cursor:pointer}
  .hidden{display:none}
  #ownerPanel{background:#222;padding:10px;margin:10px auto;border-radius:8px;max-width:520px}
</style>
</head>
<body>
<!-- Proteksi -->
<script>
  (function(){
    const current = localStorage.getItem('currentPlayer');
    if(!current){ alert('Silakan login terlebih dahulu'); location.href='login.html'; return; }
    const players = JSON.parse(localStorage.getItem('players')||'{}');
    if(!players[current]){ localStorage.removeItem('currentPlayer'); alert('Akun tidak ditemukan. Silakan login kembali.'); location.href='login.html'; }
  })();
</script>

<h1>ğŸ£ Tamagotchi Pixel Game</h1>
<div style="margin-bottom:8px;">
  <button onclick="logout()">Logout</button>
  <button onclick="goTo('inventory.html')">ğŸ“¦ Inventory</button>
  <button onclick="goTo('marketplace.html')">ğŸª Marketplace</button>
  <button onclick="goTo('leaderboard.html')">ğŸ† Leaderboard</button>
  <button onclick="goTo('chat.html')">ğŸ’¬ Chat</button>
  <button onclick="goTo('owner.html')">ğŸ” Owner</button>
</div>

<canvas id="gameCanvas" width="128" height="128" style="width:300px;height:300px"></canvas>

<div class="controls">
  <button onclick="feedPet()">ğŸ Feed (500 coin)</button>
  <button onclick="sleepPet()">ğŸ’¤ Sleep</button>
  <button onclick="earnCoin()">ğŸ’° Tap Coin</button>
  <button onclick="buyPet()">ğŸ›’ Beli Pet Level +1</button>
</div>

<div id="status" style="margin-top:8px"></div>
<div id="coinInfo"></div>

<div id="ownerPanel" class="hidden">
  <h3>OWNER PANEL</h3>
  <input id="topupName" placeholder="Nama Player">
  <input id="topupAmount" type="number" placeholder="Jumlah Coin">
  <button onclick="topup()">Top-Up</button>
  <button onclick="unlockAllPets()">Unlock Semua Pet</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;

let players = JSON.parse(localStorage.getItem('players')||'{}');
const current = localStorage.getItem('currentPlayer');
let currentPlayer = players[current];

const OWNER_USERNAME = 'owner';
const PET_PRICE_BASE = 10000;
const MAX_LEVEL = 1000;

function saveAll(){ players[current] = currentPlayer; localStorage.setItem('players', JSON.stringify(players)); }
function logout(){ localStorage.removeItem('currentPlayer'); location.href='login.html'; }
function goTo(p){ location.href=p; }

// UI awal
if(currentPlayer.username === OWNER_USERNAME) document.getElementById('ownerPanel').classList.remove('hidden');
updateUI();

// Gameplay
let animFrame = 0, animMode = 'idle';

function feedPet(){
  if(currentPlayer.coins < 500) return alert('Coin tidak cukup!');
  const now = Date.now();
  if(currentPlayer.pet.lastFeed && now - currentPlayer.pet.lastFeed < 4*60*60*1000) return alert('Tunggu 4 jam untuk makan lagi!');
  currentPlayer.coins -= 500;
  currentPlayer.pet.lastFeed = now;
  currentPlayer.pet.health = Math.min(1000, (currentPlayer.pet.health||0) + 200);
  animMode = 'happy';
  saveAll(); updateUI();
}

function sleepPet(){
  const now = Date.now();
  if(currentPlayer.pet.lastSleep && now - currentPlayer.pet.lastSleep < 24*60*60*1000) return alert('Hanya bisa tidur 1 kali sehari!');
  currentPlayer.pet.lastSleep = now;
  currentPlayer.pet.health = Math.min(1000, (currentPlayer.pet.health||0) + 300);
  animMode = 'sleep';
  saveAll(); updateUI();
}

function earnCoin(){ currentPlayer.coins += 10; saveAll(); updateUI(); }

function buyPet(){
  const price = (currentPlayer.pet.level||1) * PET_PRICE_BASE;
  if(currentPlayer.coins < price) return alert('Coin tidak cukup!');
  currentPlayer.coins -= price;
  currentPlayer.pet.level = Math.min(MAX_LEVEL, (currentPlayer.pet.level||1) + 1);
  currentPlayer.pet.evoIndex = Math.min((currentPlayer.pet.evoIndex||0)+1, 10);
  saveAll(); updateUI();
}

function updateUI(){
  document.getElementById('coinInfo').textContent = `ğŸ’° Coin: ${currentPlayer.coins} | Level: ${currentPlayer.pet.level}`;
  document.getElementById('status').textContent = `Status: ${currentPlayer.pet.alive?'Hidup':'Mati'} | HP: ${currentPlayer.pet.health}`;
}

function topup(){
  const name = (document.getElementById('topupName').value||'').trim().toLowerCase();
  const amt  = parseInt(document.getElementById('topupAmount').value||'0');
  if(!players[name]) return alert('Player tidak ditemukan!');
  players[name].coins = (players[name].coins||0) + (amt||0);
  localStorage.setItem('players', JSON.stringify(players));
  alert(`Top-up ${amt} coin ke ${name} berhasil!`);
}

function unlockAllPets(){
  currentPlayer.pet.level = MAX_LEVEL;
  saveAll();
  alert('Semua pet unlocked!');
}

function drawPet(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#08121a'; ctx.fillRect(0,0,canvas.width,canvas.height);

  const px = 40 + Math.sin(animFrame/10)*10, py = 60;
  ctx.fillStyle = '#ffd07a'; ctx.fillRect(px,py,40,30); // body
  ctx.fillStyle = '#111';    ctx.fillRect(px+8, py+8, 5,5); ctx.fillRect(px+26, py+8, 5,5); // eyes

  if(animMode==='happy'){ ctx.fillStyle = '#ff66a6'; ctx.fillRect(px+15, py+18,10,4); }
  else if(animMode==='sleep'){ ctx.fillStyle = '#88f'; ctx.fillRect(px+10, py+18,20,4); }
  else { ctx.fillStyle = '#fff'; ctx.fillRect(px+18, py+18,4,4); }

  animFrame++;
  requestAnimationFrame(drawPet);
}
drawPet();
</script>
</body>
</html>
