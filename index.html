<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamagotchi Online ‚Äî Login</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center;margin:0;padding:24px}
  .card{display:inline-block;background:#101a2b;padding:18px;border-radius:12px;min-width:300px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:0}
  button{background:#10b981;color:#06261f;font-weight:700;cursor:pointer}
  .muted{color:#9fb3b5;font-size:13px}
</style>
</head>
<body>
  <h1>üê£ Tamagotchi Online</h1>
  <div class="card">
    <h3>Login</h3>
    <input id="loginId" placeholder="Email atau Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p class="muted">Belum punya akun? Daftar di bawah</p>
    <hr style="border-color:#223;">
    <h3>Daftar</h3>
    <input id="regEmail" type="email" placeholder="Email">
    <input id="regUser" placeholder="Username (unik, huruf/angka)">
    <input id="regPass" type="password" placeholder="Password (min 6)">
    <button id="regBtn">Daftar</button>
    <div id="msg" class="muted"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // --- Firebase config (sesuai permintaan) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // Helper
    const byId = id => document.getElementById(id);
    function defaultProfile(email, username){
      return {
        email, username,
        coins: 50, level: 1,
        hunger: 100, energy: 100, hp: 100,
        currentPet: 0,
        inventory: [{name:"Chick", level:1, kind:"egg"}],
        createdAt: Date.now()
      };
    }

    // --- Register ---
    byId('regBtn').onclick = async () => {
      const email = byId('regEmail').value.trim().toLowerCase();
      const usernameRaw = byId('regUser').value.trim();
      const password = byId('regPass').value;
      const username = usernameRaw.toLowerCase();

      if(!email || !username || !password){ alert('Isi semua kolom'); return; }
      if(!/^[a-z0-9_]{3,20}$/.test(username)){ alert('Username 3‚Äì20 huruf/angka/_'); return; }

      try{
        // Cek ketersediaan username via peta 'usernames'
        const mapSnap = await db.ref('usernames/'+username).once('value');
        if(mapSnap.exists()){ alert('Username sudah dipakai ‚Äî pilih yang lain'); return; }

        const cred = await auth.createUserWithEmailAndPassword(email, password);
        const uid = cred.user.uid;

        // Tulis profil + peta username
        await db.ref('users/'+uid).set(defaultProfile(email, username));
        await db.ref('usernames/'+username).set(uid);

        location.href = 'game.html';
      }catch(err){
        alert('Gagal daftar: ' + err.message);
      }
    };

    // --- Login (email ATAU username) ---
    byId('loginBtn').onclick = async () => {
      const id = byId('loginId').value.trim().toLowerCase();
      const pass = byId('loginPass').value;
      if(!id || !pass){ alert('Isi email/username & password'); return; }

      try{
        let email = id;
        if(!id.includes('@')){
          // id adalah username ‚Üí resolve ke email lewat 'usernames'
          const uidSnap = await db.ref('usernames/'+id).once('value');
          if(!uidSnap.exists()){ alert('Username tidak ditemukan'); return; }
          const uid = uidSnap.val();
          const profSnap = await db.ref('users/'+uid).once('value');
          email = (profSnap.val() && profSnap.val().email) || '';
          if(!email){ alert('Email tidak ditemukan untuk username tsb'); return; }
        }
        await auth.signInWithEmailAndPassword(email, pass);
        location.href = 'game.html';
      }catch(err){
        alert('Gagal login: ' + err.message);
      }
    };

    // Skip login jika sudah masuk
    auth.onAuthStateChanged(u=>{ if(u) location.href='game.html'; });
  </script>
</body>
</html>
