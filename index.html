<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tamagotchi ‚Äî Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  .wrap{max-width:820px;margin:0 auto;padding:12px}
  canvas{background:#08121a;border-radius:12px;image-rendering:pixelated;margin:10px auto;display:block}
  .btn{background:#10b981;border:0;color:#042018;font-weight:700;padding:10px 12px;border-radius:10px;margin:5px;cursor:pointer}
  .btn.gray{background:#1f2937;color:#fff}
  .menu a,.menu button{display:inline-block;text-decoration:none}
  .hidden{display:none}
  .bars{max-width:420px;margin:8px auto}
  .bar{height:18px;background:#263245;border-radius:10px;margin:6px 0;overflow:hidden}
  .fill{height:100%}
  .hunger{background:#ef4444}
  .energy{background:#3b82f6}
  .hp{background:#10b981}
  input{padding:10px;border-radius:10px;border:0;margin:4px;width:260px;max-width:90%}
  small.mono{font-family:ui-monospace,Menlo,monospace;opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <h1>üê£ Tamagotchi Pixel Game</h1>

  <!-- LOGIN -->
  <div id="loginBox">
    <div><input id="loginId" placeholder="Username atau Email" /></div>
    <div><input id="loginPass" type="password" placeholder="Password" /></div>
    <div><button class="btn" onclick="doLogin()">Login</button></div>
    <div><a class="btn gray" href="register.html">Daftar Akun Baru</a></div>
    <p><small class="mono">Login sekali ‚Üí halaman lain otomatis mengenali akunmu.</small></p>
  </div>

  <!-- GAME UI -->
  <div id="gameUI" class="hidden">
    <div class="menu">
      <a class="btn gray" href="inventory.html">üì¶ Inventory</a>
      <a class="btn gray" href="marketplace.html">üè™ Marketplace</a>
      <a class="btn gray" href="leaderboard.html">üèÜ Leaderboard</a>
      <a class="btn gray" href="chat.html">üí¨ Chat</a>
      <a id="ownerLink" class="btn gray hidden" href="owner.html">üõ†Ô∏è Owner</a>
      <button class="btn" onclick="logout()">üö™ Logout</button>
    </div>

    <p id="welcome"></p>

    <canvas id="cv" width="128" height="128" style="width:320px;height:320px"></canvas>

    <div class="bars">
      <div class="bar"><div id="barH" class="fill hunger" style="width:100%"></div></div>
      <div class="bar"><div id="barE" class="fill energy" style="width:100%"></div></div>
      <div class="bar"><div id="barHP" class="fill hp" style="width:100%"></div></div>
    </div>

    <div id="status"></div>
    <div id="coinInfo" style="margin:.35rem 0 1rem"></div>

    <div>
      <button class="btn" onclick="buyFeed()">üçé Feed (+10%, 100c)</button>
      <button class="btn" onclick="buySleep()">üò¥ Sleep (+10%, 100c)</button>
    </div>
    <div>
      <button class="btn" onclick="tapCoin()">üí∞ Tap Coin (+10)</button>
      <button class="btn" onclick="levelUpManual()">‚¨ÜÔ∏è Naik Level (100.000c)</button>
    </div>
    <div>
      <button class="btn" onclick="buyNewPet()">üêæ Beli Pet Baru (harga dinamis)</button>
    </div>
    <p><small class="mono">
      Hunger & Energy -1%/menit. Jika keduanya 0% ‚Üí HP -20%/menit. HP=0 ‚Üí pet mati & reset Level 1.<br/>
      Harga Pet Baru: 200.000 √ó (jumlah pet + 1). Masuk ke Inventory, bisa dijual di Marketplace.
    </small></p>
  </div>
</div>

<script>
/* ====== STORAGE ====== */
let players = JSON.parse(localStorage.getItem('players')||'{}');
function savePlayers(){ localStorage.setItem('players', JSON.stringify(players)); }
function setSession(username){ localStorage.setItem('lastUser', username); }
function getSession(){ return localStorage.getItem('lastUser'); }
function clearSession(){ localStorage.removeItem('lastUser'); }

/* ====== HELPERS ====== */
function createPet(level=1){
  return { id: 'P'+Date.now()+Math.random().toString(16).slice(2), level, hunger:100, energy:100, hp:100 };
}
function ensurePlayer(username, pass, email){
  if(!players[username]){
    players[username] = {
      username, email: email||'', password: pass,
      coins: 1000, pets: [createPet(1)], activePet: 0, lastTick: Date.now()
    };
  }
}
function getUserByLogin(id){
  id = (id||'').trim().toLowerCase();
  if(!id) return null;
  if(id.includes('@')){
    const hit = Object.entries(players).find(([u,p]) => (p.email||'').toLowerCase()===id);
    return hit ? hit[0] : null;
  }
  return players[id] ? id : null;
}

/* ====== LOGIN ====== */
let me=null, myName=null;
function doLogin(){
  const id = document.getElementById('loginId').value;
  const pass = (document.getElementById('loginPass').value||'').trim();
  if(!id||!pass) return alert('Isi username/email dan password.');

  const uname = getUserByLogin(id);
  if(!uname){
    if(id.includes('@')) return alert('Email belum terdaftar. Silakan daftar di halaman Register.');
    // auto-register cepat jika username belum ada
    const u = id.trim().toLowerCase();
    ensurePlayer(u, pass, '');
    savePlayers();
    return proceedLogin(u);
  }
  if(players[uname].password !== pass) return alert('Username/Email atau password salah');
  proceedLogin(uname);
}
function proceedLogin(uname){
  myName = uname; me = players[uname];
  setSession(uname); savePlayers();
  showGame();
}
function logout(){ clearSession(); location.href='index.html'; }

/* ====== AUTO LOGIN ====== */
(function auto(){
  const last = getSession();
  if(last && players[last]){ myName=last; me=players[last]; showGame(); }
})();

/* ====== GAME UI ====== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d'); ctx.imageSmoothingEnabled = false;
let frame=0;

function showGame(){
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('gameUI').classList.remove('hidden');
  document.getElementById('welcome').textContent = `Selamat datang, ${myName}!`;
  if(myName.toLowerCase()==='owner') document.getElementById('ownerLink').classList.remove('hidden');
  catchUpDecay();
  updateUI();
  loop();
}
function pet(){ return me.pets[me.activePet] || me.pets[0]; }
function updateUI(){
  const p = pet();
  document.getElementById('barH').style.width = p.hunger + '%';
  document.getElementById('barE').style.width = p.energy + '%';
  document.getElementById('barHP').style.width = p.hp + '%';
  document.getElementById('status').textContent = `‚ù§Ô∏è HP ${p.hp}% ‚Ä¢ üçé Hunger ${p.hunger}% ‚Ä¢ üò¥ Energy ${p.energy}% ‚Ä¢ Lv ${p.level}`;
  document.getElementById('coinInfo').textContent = `üí∞ Coin: ${me.coins} ‚Ä¢ Pet Aktif: ${me.activePet+1}/${me.pets.length}`;
}

/* ====== MEKANIK ====== */
function buyFeed(){
  const p = pet();
  if(me.coins<100) return alert('Coin tidak cukup');
  me.coins -= 100;
  p.hunger = Math.min(100, p.hunger + 10);
  savePlayers(); updateUI();
}
function buySleep(){
  const p = pet();
  if(me.coins<100) return alert('Coin tidak cukup');
  me.coins -= 100;
  p.energy = Math.min(100, p.energy + 10);
  savePlayers(); updateUI();
}
function tapCoin(){ me.coins += 10; savePlayers(); updateUI(); }
function levelUpManual(){
  const p = pet();
  if(me.coins < 100000) return alert('Coin tidak cukup (butuh 100.000)');
  me.coins -= 100000; p.level += 1;
  p.hunger=100; p.energy=100; p.hp=100;
  savePlayers(); updateUI();
}
function buyNewPet(){
  const price = 200000 * (me.pets.length + 1);
  if(me.coins < price) return alert(`Coin tidak cukup. Harga: ${price}`);
  me.coins -= price;
  me.pets.push(createPet(1));
  savePlayers(); updateUI();
  alert('Pet baru dibeli! Cek Inventory untuk mengaktifkan atau menjual.');
}
function decayOneMinute(p){
  p.hunger = Math.max(0, p.hunger - 1);
  p.energy = Math.max(0, p.energy - 1);
  if(p.hunger===0 && p.energy===0){ p.hp = Math.max(0, p.hp - 20); }
  if(p.hp<=0){
    alert('üíÄ Pet aktif mati! Reset ke Level 1.');
    p.level=1; p.hunger=100; p.energy=100; p.hp=100;
  }
}
function catchUpDecay(){
  const p = pet();
  const now = Date.now();
  const last = me.lastTick || now;
  const diffMin = Math.floor((now-last)/60000);
  for(let i=0;i<diffMin;i++) decayOneMinute(p);
  me.lastTick = now; savePlayers();
}
setInterval(()=>{
  if(!me) return;
  decayOneMinute(pet());
  me.lastTick = Date.now();
  savePlayers(); updateUI();
}, 60000);

/* ====== SPRITE & ANIM ====== */
function drawPet(){
  const p = pet();
  ctx.clearRect(0,0,128,128);
  ctx.fillStyle = '#08121a'; ctx.fillRect(0,0,128,128);

  // bintang latar
  for(let i=0;i<18;i++){
    ctx.fillStyle = 'rgba(255,255,255,.13)';
    ctx.fillRect((i*13 + frame)%128, (i*7 + frame*0.8)%128, 1, 1);
  }

  // tier warna bentuk
  let tier=0, body='#ffd07a';
  if(p.level<5){ tier=0; body='#ffd07a'; }
  else if(p.level<10){ tier=1; body='#93c5fd'; }
  else if(p.level<20){ tier=2; body='#34d399'; }
  else if(p.level<50){ tier=3; body='#f472b6'; }
  else { tier=4; body='#fbbf24'; }

  const wobX = Math.sin(frame/12)*3;
  const wobY = Math.cos(frame/18)*2;
  const x = 64 + wobX, y = 70 + wobY;

  ctx.fillStyle = body;
  if(tier===0){ ctx.fillRect(x-14,y-12,28,22); }
  else if(tier===1){ ctx.beginPath(); ctx.arc(x,y,16,0,Math.PI*2); ctx.fill(); }
  else if(tier===2){ ctx.fillRect(x-18,y-16,36,30); ctx.fillStyle='#222'; ctx.fillRect(x-10,y-22,20,6); ctx.fillStyle=body; }
  else if(tier===3){ ctx.beginPath(); ctx.arc(x,y,22,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#222'; ctx.fillRect(x-2,y-30,4,10); ctx.fillStyle=body; ctx.fillRect(x-3,y-34,6,4); }
  else { ctx.beginPath(); ctx.moveTo(x,y-24); ctx.lineTo(x+24,y+20); ctx.lineTo(x-24,y+20); ctx.closePath(); ctx.fill();
         ctx.fillStyle='#fff'; ctx.fillRect(x-28,y-2,10,4); ctx.fillRect(x+18,y-2,10,4); ctx.fillStyle=body; }

  // mata
  const blink = Math.floor(frame/50)%2===0;
  ctx.fillStyle = '#0b0b0b';
  if(blink){ ctx.fillRect(x-6,y-2,3,3); ctx.fillRect(x+3,y-2,3,3); }
  else{ ctx.fillRect(x-6,y-1,3,1); ctx.fillRect(x+3,y-1,3,1); }

  // mulut berubah sesuai HP
  ctx.fillStyle = (p.hp>50)?'#fff':'#ff7b7b';
  ctx.fillRect(x-4,y+6,8,2);

  frame++;
}
function loop(){ if(!me) return; drawPet(); requestAnimationFrame(loop); }
</script>
</body>
</html>
