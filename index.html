<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamagotchi Online â€” Game</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  .wrap{max-width:860px;margin:0 auto;padding:12px}
  canvas{background:#08121a;border-radius:12px;image-rendering:pixelated;margin:10px auto;display:block}
  .btn{background:#10b981;border:0;color:#042018;font-weight:700;padding:10px 12px;border-radius:10px;margin:5px;cursor:pointer}
  .btn.gray{background:#1f2937;color:#fff}
  .hidden{display:none}
  .bars{max-width:420px;margin:8px auto}
  .bar{height:18px;background:#263245;border-radius:10px;margin:6px 0;overflow:hidden}
  .fill{height:100%}
  .hunger{background:#ef4444}
  .energy{background:#3b82f6}
  .hp{background:#10b981}
  input{padding:10px;border-radius:10px;border:0;margin:4px;width:260px;max-width:90%}
  small.mono{font-family:ui-monospace,Menlo,monospace;opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ£ Tamagotchi Online</h1>

  <div id="authBox">
    <h3>Login</h3>
    <input id="loginId" placeholder="Username atau Email">
    <input id="loginPass" type="password" placeholder="Password">
    <button class="btn" id="btnLogin">Login</button>

    <h3>Daftar</h3>
    <input id="regUser" placeholder="Username">
    <input id="regEmail" type="email" placeholder="Email">
    <input id="regPass" type="password" placeholder="Password">
    <button class="btn" id="btnReg">Daftar</button>

    <p><small class="mono">Data disimpan online (Firestore). Login berlaku di semua halaman.</small></p>
  </div>

  <div id="gameUI" class="hidden">
    <div class="menu">
      <a class="btn gray" href="inventory.html">ğŸ“¦ Inventory</a>
      <a class="btn gray" href="marketplace.html">ğŸª Marketplace</a>
      <a class="btn gray" href="leaderboard.html">ğŸ† Leaderboard</a>
      <a class="btn gray" href="chat.html">ğŸ’¬ Chat</a>
      <a id="ownerLink" class="btn gray hidden" href="owner.html">ğŸ› ï¸ Owner</a>
      <button class="btn" id="btnLogout">ğŸšª Logout</button>
    </div>

    <p id="welcome"></p>
    <canvas id="cv" width="128" height="128" style="width:320px;height:320px"></canvas>

    <div class="bars">
      <div class="bar"><div id="barH" class="fill hunger"></div></div>
      <div class="bar"><div id="barE" class="fill energy"></div></div>
      <div class="bar"><div id="barHP" class="fill hp"></div></div>
    </div>

    <div id="status"></div>
    <div id="coinInfo" style="margin:.35rem 0 1rem"></div>

    <div>
      <button class="btn" id="btnFeed">ğŸ Feed (+10%, 100c)</button>
      <button class="btn" id="btnSleep">ğŸ˜´ Sleep (+10%, 100c)</button>
    </div>
    <div>
      <button class="btn" id="btnTap">ğŸ’° Tap Coin (+10)</button>
      <button class="btn" id="btnLv">â¬†ï¸ Naik Level (100.000c)</button>
    </div>
    <div>
      <button class="btn" id="btnBuyPet">ğŸ¾ Beli Pet Baru (harga dinamis)</button>
    </div>
  </div>
</div>

<!-- Firebase Config + Online adapter -->
<script type="module" src="js/firebase-config.js"></script>
<script type="module" src="js/online.js"></script>

<script type="module">
import {
  auth, db, onAuth, register, login, logout, subPlayer, getPlayer,
  buyFeed,buySleep,tapCoin,levelUp,buyNewPet, tickDecay, isOwner
} from './js/online.js';

const authBox = document.getElementById('authBox');
const gameUI  = document.getElementById('gameUI');
const welcome = document.getElementById('welcome');
const cv = document.getElementById('cv'); const ctx = cv.getContext('2d'); ctx.imageSmoothingEnabled=false;
let uid=null, unsubPlayer=null, player=null, frame=0;

document.getElementById('btnLogin').onclick = async ()=>{
  try{
    const id  = document.getElementById('loginId').value;
    const pwd = document.getElementById('loginPass').value;
    await login({idOrEmail:id, password:pwd});
  }catch(e){ alert(e.message); }
};
document.getElementById('btnReg').onclick = async ()=>{
  try{
    const u = document.getElementById('regUser').value;
    const e = document.getElementById('regEmail').value;
    const p = document.getElementById('regPass').value;
    await register({username:u, email:e, password:p});
  }catch(e){ alert(e.message); }
};
document.getElementById('btnLogout').onclick = ()=> logout();

onAuth(async (user)=>{
  if(user){
    uid=user.uid;
    authBox.classList.add('hidden');
    gameUI.classList.remove('hidden');
    welcome.textContent = `Selamat datang, ${user.displayName||user.email}!`;

    // owner link
    if(await isOwner(uid)) document.getElementById('ownerLink').classList.remove('hidden');

    // subscribe player realtime
    if(unsubPlayer) unsubPlayer();
    unsubPlayer = subPlayer(uid, async (p)=>{
      player = p;
      // catch-up decay secara lokal lalu push ke cloud
      tickDecay(player);
      // simpan lastTick dan pets jika berubah (debounce ringan)
      await Promise.resolve(); // biar tidak blocking
      // Tidak updateDoc tiap frameâ€”hanya saat login & timer 1 menit dari loop di bawah
      updateUI();
    });
    startLoops();
  }else{
    uid=null; player=null;
    if(unsubPlayer){ unsubPlayer(); unsubPlayer=null; }
    gameUI.classList.add('hidden');
    authBox.classList.remove('hidden');
  }
});

// UI Actions
document.getElementById('btnFeed').onclick = ()=> uid && buyFeed(uid).catch(e=>alert(e.message));
document.getElementById('btnSleep').onclick= ()=> uid && buySleep(uid).catch(e=>alert(e.message));
document.getElementById('btnTap').onclick  = ()=> uid && tapCoin(uid).catch(e=>alert(e.message));
document.getElementById('btnLv').onclick   = ()=> uid && levelUp(uid).catch(e=>alert(e.message));
document.getElementById('btnBuyPet').onclick = ()=> uid && buyNewPet(uid).catch(e=>alert(e.message));

function curPet(){
  if(!player) return null;
  const idx = player.activePet || 0;
  return player.pets?.[idx] || null;
}
function updateUI(){
  const p = curPet(); if(!p) return;
  document.getElementById('barH').style.width  = p.hunger+'%';
  document.getElementById('barE').style.width  = p.energy+'%';
  document.getElementById('barHP').style.width = p.hp+'%';
  document.getElementById('status').textContent = `â¤ï¸ HP ${p.hp}% â€¢ ğŸ Hunger ${p.hunger}% â€¢ ğŸ˜´ Energy ${p.energy}% â€¢ Lv ${p.level}`;
  document.getElementById('coinInfo').textContent = `ğŸ’° Coin: ${player.coins} â€¢ Pet Aktif: ${(player.activePet||0)+1}/${player.pets.length}`;
}

function drawPet(){
  const p = curPet(); if(!p) return;
  ctx.clearRect(0,0,128,128);
  ctx.fillStyle='#08121a'; ctx.fillRect(0,0,128,128);

  for(let i=0;i<18;i++){
    ctx.fillStyle='rgba(255,255,255,.13)';
    ctx.fillRect((i*13 + frame)%128, (i*7 + frame*0.8)%128, 1, 1);
  }
  let tier=0, body='#ffd07a';
  if(p.level<5){ tier=0; body='#ffd07a'; }
  else if(p.level<10){ tier=1; body='#93c5fd'; }
  else if(p.level<20){ tier=2; body='#34d399'; }
  else if(p.level<50){ tier=3; body='#f472b6'; }
  else { tier=4; body='#fbbf24'; }

  const wobX = Math.sin(frame/12)*3;
  const wobY = Math.cos(frame/18)*2;
  const x=64+wobX, y=70+wobY;

  ctx.fillStyle = body;
  if(tier===0){ ctx.fillRect(x-14,y-12,28,22); }
  else if(tier===1){ ctx.beginPath(); ctx.arc(x,y,16,0,Math.PI*2); ctx.fill(); }
  else if(tier===2){ ctx.fillRect(x-18,y-16,36,30); ctx.fillStyle='#222'; ctx.fillRect(x-10,y-22,20,6); ctx.fillStyle=body; }
  else if(tier===3){ ctx.beginPath(); ctx.arc(x,y,22,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#222'; ctx.fillRect(x-2,y-30,4,10); ctx.fillStyle=body; ctx.fillRect(x-3,y-34,6,4); }
  else { ctx.beginPath(); ctx.moveTo(x,y-24); ctx.lineTo(x+24,y+20); ctx.lineTo(x-24,y+20); ctx.closePath(); ctx.fill();
         ctx.fillStyle='#fff'; ctx.fillRect(x-28,y-2,10,4); ctx.fillRect(x+18,y-2,10,4); ctx.fillStyle=body; }

  const blink = Math.floor(frame/50)%2===0;
  ctx.fillStyle='#0b0b0b';
  if(blink){ ctx.fillRect(x-6,y-2,3,3); ctx.fillRect(x+3,y-2,3,3); }
  else{ ctx.fillRect(x-6,y-1,3,1); ctx.fillRect(x+3,y-1,3,1); }

  ctx.fillStyle=(p.hp>50)?'#fff':'#ff7b7b';
  ctx.fillRect(x-4,y+6,8,2);
  frame++;
}

function startLoops(){
  function raf(){ if(!player) return; drawPet(); requestAnimationFrame(raf); }
  raf();
  // tiap 1 menit: apply decay dan push ke server
  setInterval(async ()=>{
    if(!uid || !player) return;
    tickDecay(player);
    await (await import('./js/online.js')).savePlayer(uid, { pets: player.pets, lastTick: Date.now() });
  }, 60000);
}
</script>
</body>
</html>
