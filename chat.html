<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat App</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // 🔥 Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentRoom = "global"; // default chat global

    // 🔐 Login Anonim
    signInAnonymously(auth).catch(console.error);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log("Login sebagai:", user.uid);
        loadGlobalChat();
      }
    });

    // 🎵 Ambil elemen audio
    const notifSound = document.getElementById("notifSound");

    // 📌 Kirim Pesan
    document.getElementById("sendBtn").addEventListener("click", () => {
      const text = document.getElementById("msgInput").value.trim();
      if (!text) return;

      let chatRef;
      if (currentRoom === "global") {
        chatRef = ref(db, "chat");
      } else {
        chatRef = ref(db, "privateChat/" + currentRoom + "/messages");
      }

      const newMsg = push(chatRef);
      set(newMsg, {
        from: currentUser.uid,
        text: text,
        timestamp: Date.now()
      });

      document.getElementById("msgInput").value = "";
    });

    // 📌 Load Global Chat
    function loadGlobalChat() {
      const chatBox = document.getElementById("messages");
      chatBox.innerHTML = "<h3>🌍 Global Chat</h3>";

      const chatRef = ref(db, "chat");
      onChildAdded(chatRef, (snapshot) => {
        const msg = snapshot.val();
        const div = document.createElement("div");
        div.textContent = (msg.from === currentUser.uid ? "Saya" : msg.from) + ": " + msg.text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        notifSound.play();
      });
    }

    // 📌 Load Private Chat
    function loadPrivateChat(roomId) {
      currentRoom = roomId;
      const chatBox = document.getElementById("messages");
      chatBox.innerHTML = "<h3>🔒 Private Chat: " + roomId + "</h3>";

      const chatRef = ref(db, "privateChat/" + roomId + "/messages");
      onChildAdded(chatRef, (snapshot) => {
        const msg = snapshot.val();
        const div = document.createElement("div");
        div.textContent = (msg.from === currentUser.uid ? "Saya" : msg.from) + ": " + msg.text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        notifSound.play();
      });
    }

    // 📌 Ganti Room (Global / Private)
    document.getElementById("globalBtn").addEventListener("click", () => {
      currentRoom = "global";
      loadGlobalChat();
    });

    document.getElementById("privateBtn").addEventListener("click", () => {
      const roomId = prompt("Masukkan Room ID untuk Private Chat:");
      if (roomId) loadPrivateChat(roomId);
    });

  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; }
    #chatContainer { width: 400px; margin: 20px auto; border: 1px solid #ccc; background: white; border-radius: 10px; }
    #messages { height: 300px; overflow-y: auto; padding: 10px; border-bottom: 1px solid #ddd; }
    #inputArea { display: flex; padding: 10px; }
    #msgInput { flex: 1; padding: 8px; }
    button { margin-left: 5px; padding: 8px 12px; }
  </style>
</head>
<body>
  <div id="chatContainer">
    <div style="padding:10px; border-bottom:1px solid #ddd;">
      <button id="globalBtn">🌍 Global Chat</button>
      <button id="privateBtn">🔒 Private Chat</button>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input id="msgInput" type="text" placeholder="Ketik pesan..." />
      <button id="sendBtn">Kirim</button>
    </div>
  </div>

  <!-- 🔔 Notifikasi (mirip WhatsApp) -->
  <audio id="notifSound" src="https://assets.mixkit.co/sfx/download/mixkit-software-interface-back-2575.wav"></audio>
</body>
</html>
