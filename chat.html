<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, off } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentRoom = null;
    let privateListener = null;

    signInAnonymously(auth).then((res) => {
      currentUser = res.user.uid;
      document.getElementById("userId").innerText = "User ID: " + currentUser;
    });

    // === GLOBAL CHAT ===
    const globalRef = ref(db, "chat");
    onChildAdded(globalRef, (snap) => {
      const msg = snap.val();
      appendMessage("globalMessages", msg);
    });

    document.getElementById("sendGlobal").onclick = () => {
      const text = document.getElementById("globalInput").value;
      if (!text) return;
      push(globalRef, {
        from: currentUser,
        text,
        timestamp: Date.now()
      });
      document.getElementById("globalInput").value = "";
    };

    // === PRIVATE CHAT ===
    function getRoomId(user1, user2) {
      return [user1, user2].sort().join("_");
    }

    function loadPrivateChat(targetUser) {
      if (!currentUser) return;
      const roomId = getRoomId(currentUser, targetUser);

      // stop listener lama
      if (privateListener) off(privateListener);

      currentRoom = roomId;
      document.getElementById("privateMessages").innerHTML = "";

      const privateRef = ref(db, `privateChat/${roomId}/messages`);
      privateListener = privateRef;

      onChildAdded(privateRef, (snap) => {
        const msg = snap.val();
        appendMessage("privateMessages", msg);
      });
    }

    document.getElementById("sendPrivate").onclick = () => {
      const text = document.getElementById("privateInput").value;
      const targetUser = document.getElementById("targetUser").value;
      if (!text || !targetUser) return;

      const roomId = getRoomId(currentUser, targetUser);
      const privateRef = ref(db, `privateChat/${roomId}/messages`);

      push(privateRef, {
        from: currentUser,
        text,
        timestamp: Date.now()
      });

      document.getElementById("privateInput").value = "";
    };

    // === Utility render pesan ===
    function appendMessage(containerId, msg) {
      const div = document.createElement("div");
      div.innerHTML = `<b>${msg.from}:</b> ${msg.text}`;
      document.getElementById(containerId).appendChild(div);
    }

    // tombol join private chat
    window.joinPrivate = () => {
      const targetUser = document.getElementById("targetUser").value;
      if (targetUser) loadPrivateChat(targetUser);
    };
  </script>
</head>
<body>
  <h1>ğŸ”¥ Chat App</h1>
  <p id="userId">Loading...</p>

  <hr>
  <h2>ğŸŒ Global Chat</h2>
  <div id="globalMessages" style="border:1px solid #ccc; height:150px; overflow-y:scroll;"></div>
  <input id="globalInput" placeholder="Tulis pesan...">
  <button id="sendGlobal">Kirim</button>

  <hr>
  <h2>ğŸ”’ Private Chat</h2>
  <input id="targetUser" placeholder="Masukkan UserID tujuan...">
  <button onclick="joinPrivate()">Join Private Chat</button>
  <div id="privateMessages" style="border:1px solid #ccc; height:150px; overflow-y:scroll;"></div>
  <input id="privateInput" placeholder="Tulis pesan...">
  <button id="sendPrivate">Kirim</button>
</body>
</html>
