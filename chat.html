<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <style>
    body { font-family: Arial; margin: 0; display: flex; height: 100vh; }
    #sidebar { width: 250px; background: #f5f5f5; padding: 10px; border-right: 1px solid #ddd; }
    #main { flex: 1; display: flex; flex-direction: column; }
    #messages, #privateMessages { flex: 1; overflow-y: auto; padding: 10px; }
    li { list-style: none; margin: 5px 0; }
    img.avatar { width: 35px; height: 35px; border-radius: 50%; vertical-align: middle; margin-right: 5px; }
    .msg { display: flex; align-items: center; }
    .msg span { background: #e1ffc7; padding: 5px 10px; border-radius: 10px; }
    #inputBar { display: flex; padding: 10px; border-top: 1px solid #ddd; }
    #inputBar input { flex: 1; padding: 8px; }
    #inputBar button { padding: 8px; margin-left: 5px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Chat Menu</h3>
    <button id="googleLogin">Login Google</button>
    <div id="profileBox" style="display:none;">
      <img id="profileAvatar" class="avatar" src="">
      <p id="profileName"></p>
      <input type="file" id="avatarUpload">
      <button id="saveAvatar">Simpan Avatar</button>
    </div>
    <hr>
    <button onclick="showGlobal()">üåç Global Chat</button>
    <button onclick="showPrivate()">üîí Private Chat</button>
  </div>

  <div id="main">
    <!-- Global Chat -->
    <div id="globalBox">
      <ul id="messages"></ul>
      <div id="inputBar">
        <input id="messageInput" placeholder="Ketik pesan global...">
        <button id="sendBtn">Kirim</button>
      </div>
    </div>

    <!-- Private Chat -->
    <div id="privateBox" style="display:none;">
      <ul id="privateMessages"></ul>
      <div id="inputBar">
        <input id="privateInput" placeholder="Ketik pesan privat...">
        <button id="privateSendBtn">Kirim</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    let me = null;
    let roomId = "demoRoom"; // sementara 1 room private

    // Login
    document.getElementById("googleLogin").onclick = async () => {
      await signInWithPopup(auth, provider);
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        me = { uid: user.uid, name: user.displayName, avatar: user.photoURL || "" };
        document.getElementById("profileBox").style.display = "block";
        document.getElementById("profileName").innerText = me.name;
        document.getElementById("profileAvatar").src = me.avatar || "https://via.placeholder.com/35";
      }
    });

    // Upload avatar
    document.getElementById("saveAvatar").onclick = async () => {
      const file = document.getElementById("avatarUpload").files[0];
      if (!file || !me) return;
      const storageRef = sRef(storage, "avatars/" + me.uid);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      me.avatar = url;
      document.getElementById("profileAvatar").src = url;
    };

    // Global Chat
    const messages = document.getElementById("messages");
    document.getElementById("sendBtn").onclick = async () => {
      const text = document.getElementById("messageInput").value.trim();
      if (!text || !me) return;
      await push(ref(db, "chat"), {
        from: me.name, uid: me.uid, avatar: me.avatar, text, timestamp: Date.now()
      });
      document.getElementById("messageInput").value = "";
    };
    onChildAdded(ref(db, "chat"), (snap) => {
      const msg = snap.val();
      const li = document.createElement("li");
      li.innerHTML = `<div class="msg"><img src="${msg.avatar || 'https://via.placeholder.com/35'}" class="avatar"><span><b>${msg.from}:</b> ${msg.text}</span></div>`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    });

    // Private Chat
    const privateMessages = document.getElementById("privateMessages");
    document.getElementById("privateSendBtn").onclick = async () => {
      const text = document.getElementById("privateInput").value.trim();
      if (!text || !me) return;
      await push(ref(db, "privateChat/" + roomId + "/messages"), {
        from: me.name, uid: me.uid, avatar: me.avatar, text, timestamp: Date.now()
      });
      document.getElementById("privateInput").value = "";
    };
    onChildAdded(ref(db, "privateChat/" + roomId + "/messages"), (snap) => {
      const msg = snap.val();
      const li = document.createElement("li");
      li.innerHTML = `<div class="msg"><img src="${msg.avatar || 'https://via.placeholder.com/35'}" class="avatar"><span><b>${msg.from}:</b> ${msg.text}</span></div>`;
      privateMessages.appendChild(li);
      privateMessages.scrollTop = privateMessages.scrollHeight;
    });

    // Switch
    window.showGlobal = () => {
      document.getElementById("globalBox").style.display = "block";
      document.getElementById("privateBox").style.display = "none";
    };
    window.showPrivate = () => {
      document.getElementById("globalBox").style.display = "none";
      document.getElementById("privateBox").style.display = "block";
    };
  </script>
</body>
</html>
