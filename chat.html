<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat (Global & Private)</title>
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let currentUser = null;
    let currentRoom = "global"; // default global chat

    // Login anon
    signInAnonymously(auth).catch(err => console.error(err));

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        console.log("Login sebagai:", user.uid);
        loadMessages("global");
      }
    });

    // Kirim pesan
    async function sendMessage() {
      const text = document.getElementById("messageInput").value;
      if (!text.trim()) return;

      let msgRef;
      if (currentRoom === "global") {
        msgRef = ref(db, "chat");
      } else {
        msgRef = ref(db, `privateChat/${currentRoom}/messages`);
        // pastikan user masuk members
        const memberRef = ref(db, `privateChat/${currentRoom}/members/${currentUser.uid}`);
        await set(memberRef, true);
      }

      push(msgRef, {
        from: currentUser.uid,
        text: text,
        timestamp: Date.now()
      });

      document.getElementById("messageInput").value = "";
    }

    // Load pesan
    function loadMessages(room) {
      document.getElementById("messages").innerHTML = "";
      currentRoom = room;

      let msgRef = room === "global" 
        ? ref(db, "chat") 
        : ref(db, `privateChat/${room}/messages`);

      onChildAdded(msgRef, snap => {
        const msg = snap.val();
        const div = document.createElement("div");
        div.textContent = msg.from + ": " + msg.text;
        document.getElementById("messages").appendChild(div);
      });
    }

    // Buat/join private chat
    async function startPrivateChat(otherUserId) {
      // Room ID unik: urutkan 2 uid (biar konsisten)
      const ids = [currentUser.uid, otherUserId].sort().join("_");
      const roomId = "room_" + ids;

      // Tambahkan kedua user ke members
      const membersRef = ref(db, `privateChat/${roomId}/members`);
      await update(membersRef, {
        [currentUser.uid]: true,
        [otherUserId]: true
      });

      loadMessages(roomId);
    }

    // expose ke window
    window.sendMessage = sendMessage;
    window.loadMessages = loadMessages;
    window.startPrivateChat = startPrivateChat;
  </script>
</head>
<body>
  <h2>Chat App</h2>
  <button onclick="loadMessages('global')">ğŸŒ Global Chat</button>
  <button onclick="startPrivateChat(prompt('Masukkan UID teman:'))">ğŸ’¬ Private Chat</button>

  <div id="messages" style="border:1px solid #aaa; height:300px; overflow-y:auto; margin:10px 0; padding:5px;">
  </div>

  <input id="messageInput" placeholder="Ketik pesan..." />
  <button onclick="sendMessage()">Kirim</button>
</body>
</html>
