<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;margin:0;padding:12px}
  #box{background:#0f172a;border-radius:10px;height:55vh;overflow-y:auto;padding:10px}
  .row{margin:6px 0}
  input,button,select{padding:8px;border-radius:8px;border:0;margin:4px}
  button{background:#10b981;color:#06261f;font-weight:700;cursor:pointer}
</style>
</head>
<body>
  <h2>üí¨ Chat</h2>
  <div>
    Mode:
    <select id="mode" onchange="switchMode()">
      <option value="global">Global</option>
      <option value="pm">Private</option>
    </select>
    <span id="pmBox" style="display:none">
      ke <input id="toUser" placeholder="username tujuan" style="width:160px">
      <button onclick="setPeer()">Set</button>
    </span>
  </div>
  <div id="box"></div>
  <div>
    <input id="msg" placeholder="Tulis pesan‚Ä¶" style="width:70%">
    <button onclick="sendMsg()">Kirim</button>
    <button onclick="nav('game.html')">‚¨ÖÔ∏è Kembali</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const cfg={apiKey:"AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",authDomain:"tamagotchi-2be0c.firebaseapp.com",databaseURL:"https://tamagotchi-2be0c-default-rtdb.firebaseio.com",projectId:"tamagotchi-2be0c",storageBucket:"tamagotchi-2be0c.firebasestorage.app",messagingSenderId:"202052432703",appId:"1:202052432703:web:cb76b50e42149a2c92998a",measurementId:"G-TWGGSJRX26"};
    firebase.initializeApp(cfg); const auth=firebase.auth(), db=firebase.database();

    let me, uid, myUser, mode='global', peerUid=null, unlisten=null;

    function nav(p){ location.href=p; }
    function el(id){ return document.getElementById(id); }

    function switchMode(){
      mode = el('mode').value;
      el('pmBox').style.display = mode==='pm' ? '' : 'none';
      listen();
    }
    async function setPeer(){
      const uname=(el('toUser').value||'').toLowerCase();
      if(!uname) return;
      const uidSnap=await db.ref('usernames/'+uname).once('value');
      if(!uidSnap.exists()) return alert('Username tidak ditemukan');
      peerUid = uidSnap.val();
      listen();
    }
    function pairKey(a,b){ return a<b? `${a}_${b}` : `${b}_${a}`; }

    function listen(){
      if(unlisten) unlisten.off();
      el('box').innerHTML='';
      if(mode==='global'){
        unlisten = db.ref('chats/global').limitToLast(200);
        unlisten.on('child_added',s=>{
          const m=s.val(); addRow(`[${new Date(m.ts).toLocaleTimeString()}] ${m.fromName}: ${m.text}`);
        });
      }else if(mode==='pm' && peerUid){
        const ref = db.ref('chats/pm/'+pairKey(uid,peerUid)).limitToLast(200);
        unlisten = ref;
        ref.on('child_added',s=>{
          const m=s.val(); addRow(`${m.from===uid?'üü¢ Kamu':'üîµ ' + m.fromName}: ${m.text}`);
        });
      }
    }
    function addRow(t){
      const d=document.createElement('div'); d.className='row'; d.textContent=t;
      el('box').appendChild(d); el('box').scrollTop = el('box').scrollHeight;
    }

    async function sendMsg(){
      const text = el('msg').value.trim(); if(!text) return;
      el('msg').value='';
      if(mode==='global'){
        await db.ref('chats/global').push({from:uid, fromName:myUser.username, text, ts:Date.now()});
      }else{
        if(!peerUid) return alert('Set username tujuan dulu');
        const ref = db.ref('chats/pm/'+pairKey(uid,peerUid));
        await ref.push({from:uid, fromName:myUser.username, text, ts:Date.now()});
      }
    }

    auth.onAuthStateChanged(async u=>{
      if(!u){ location.href='index.html'; return; }
      me=u; uid=u.uid;
      const s=await db.ref('users/'+uid).once('value'); myUser=s.val();
      listen();
    });
  </script>
</body>
</html>
