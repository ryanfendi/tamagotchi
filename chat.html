<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat WhatsApp Style</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // 🔥 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentRoom = "chat"; // default = group chat

    // 🔑 Login anonymous
    signInAnonymously(auth).then((res) => {
      currentUser = res.user.uid;
      document.getElementById("userId").innerText = "User ID: " + currentUser;
      loadMessages();
    });

    // 📌 Ganti room (global/private)
    function switchRoom(roomId) {
      document.getElementById("messages").innerHTML = "";
      currentRoom = roomId;
      loadMessages();
    }
    window.switchRoom = switchRoom;

    // 📩 Ambil pesan dari room aktif
    function loadMessages() {
      const chatRef = ref(db, currentRoom);
      onChildAdded(chatRef, (snap) => {
        const msg = snap.val();
        const key = snap.key;
        appendMessage(msg, key);

        if (msg.from !== currentUser) {
          update(ref(db, currentRoom + "/" + key), { status: "read" });
        }
      });
    }

    // ➕ Kirim pesan
    document.getElementById("sendBtn").onclick = () => {
      const text = document.getElementById("msgInput").value;
      if (!text) return;

      push(ref(db, currentRoom), {
        from: currentUser,
        text,
        timestamp: Date.now(),
        status: "sent"
      });

      document.getElementById("msgInput").value = "";
    };

    // 🖼️ Tampilkan pesan
    function appendMessage(msg, key) {
      const div = document.createElement("div");
      let statusIcon = msg.status === "read" ? "✔✔" : "✔";
      div.innerHTML = `<b>${msg.from}:</b> ${msg.text} <small>${statusIcon}</small>`;
      document.getElementById("messages").appendChild(div);
    }
  </script>
</head>
<body>
  <h1>🔥 WhatsApp Style Chat</h1>
  <p id="userId">Loading...</p>

  <!-- Menu Pilihan -->
  <button onclick="switchRoom('chat')">🌍 Group Chat</button>
  <button onclick="switchRoom('privateChat_room1')">🔒 Private Chat (Room 1)</button>

  <div id="messages" style="border:1px solid #ccc; height:200px; overflow-y:scroll; margin:10px 0;"></div>

  <input id="msgInput" placeholder="Tulis pesan...">
  <button id="sendBtn">Kirim</button>
</body>
</html>
