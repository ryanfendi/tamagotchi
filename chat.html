<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Tamagotchi ‚Äî Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5eefc; --muted:#94a3b8;
      --accent:#22c55e; --accent-2:#10b981; --border:#1f2a44; --me:#1f6feb; --them:#1e293b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--border);padding:10px}
    .row{display:flex;align-items:center;gap:8px}
    .space{flex:1}
    .btn{background:var(--accent);color:#06261f;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .ghost{background:#1e293b;color:#cfe;border:1px solid var(--border)}
    .tabs{display:flex;gap:8px;margin-top:8px}
    .tab-btn{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:#cfe;cursor:pointer}
    .tab-btn.active{background:#12203b;border-color:#284069}
    .wrap{display:flex;height:calc(100vh - 140px);gap:8px;padding:8px}
    @media(max-width:800px){.wrap{flex-direction:column;height:auto}}
    .left{width:320px;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .right{flex:1;min-height:420px;background:var(--card);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column}
    .search{padding:8px;border-bottom:1px solid var(--border)}
    .search input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:#cfe}
    .list{overflow:auto;max-height:60vh}
    .item{display:flex;gap:10px;padding:10px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:hover{background:#0e1a31}
    .ava{width:42px;height:42px;border-radius:999px;border:1px solid #1f2a44;object-fit:cover;background:#111}
    .chat-header{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--border)}
    .chat-body{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:6px;background:
      radial-gradient( circle at 20% 0%, rgba(34,197,94,.07) 0 25%, transparent 26% ) 0 0/160px 160px,
      radial-gradient( circle at 80% 100%, rgba(37,99,235,.07) 0 25%, transparent 26% ) 0 0/200px 200px,
      #0b1220}
    .b{max-width:78%;padding:8px 10px;border-radius:14px;border:1px solid var(--border);position:relative;word-wrap:break-word;white-space:pre-wrap}
    .me{align-self:flex-end;background:var(--me);border-color:#2059b6;color:#fff;border-bottom-right-radius:6px}
    .them{align-self:flex-start;background:var(--them);border-bottom-left-radius:6px}
    .meta{font-size:11px;color:#dbeafe;opacity:.8;margin-top:3px;display:flex;align-items:center;gap:6px}
    .ticks{font-size:12px;opacity:.9}
    .composer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
    .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:#cfe}
    .composer button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent-2);color:#06261f;font-weight:700;cursor:pointer}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0c1426;color:#cfe;cursor:pointer}
    .grid-ava{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .grid-ava img{width:100%;border-radius:12px;cursor:pointer;border:2px solid transparent}
    .grid-ava img.sel{border-color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <button class="btn ghost" onclick="nav('game.html')">‚üµ Kembali</button>
      <div class="space"></div>
      <button class="pill" id="btnGlobal">üåç Global</button>
      <button class="pill" id="btnPrivate">üë§ Private</button>
      <button class="pill" id="btnProfile">üñºÔ∏è Avatar</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
    <div class="tabs">
      <button id="tabGlobal" class="tab-btn active">üåç Global</button>
      <button id="tabPrivate" class="tab-btn">üë§ Private</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT: daftar user & rooms -->
    <section class="left">
      <div class="search">
        <input id="searchUser" placeholder="Cari member‚Ä¶" />
      </div>
      <div id="userList" class="list"></div>
    </section>

    <!-- RIGHT: chat -->
    <section class="right">
      <div class="chat-header">
        <img id="chatAva" class="ava" src="" alt="">
        <div>
          <div id="chatTitle" style="font-weight:700">Pilih chat</div>
          <div id="chatSub" class="small">‚Äî</div>
        </div>
        <div class="space"></div>
        <span class="small" id="whoMe">Memuat‚Ä¶</span>
      </div>

      <div id="chatBody" class="chat-body"></div>

      <div class="composer">
        <input id="msgInput" placeholder="Tulis pesan‚Ä¶" />
        <button id="btnSend">Kirim</button>
      </div>
    </section>
  </div>

  <!-- Modal profil/Avatar sederhana -->
  <div id="profileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);place-items:center;">
    <div style="width:min(520px,95vw);background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px">
      <h3 style="margin:6px 0 8px">Profil</h3>
      <div class="row" style="gap:10px;margin-bottom:8px">
        <img id="meAva" class="ava" src="" alt="">
        <input id="meName" placeholder="Username" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0c1426;color:#cfe">
        <input type="file" id="meFile" accept="image/*" style="display:none">
        <button class="pill" id="btnUpload">Upload Foto</button>
      </div>
      <div class="small">Atau pilih avatar anime lucu:</div>
      <div id="avaChoices" class="grid-ava"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="pill" id="btnCloseProfile">Tutup</button>
        <button class="btn" id="btnSaveProfile">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Notifikasi suara (mirip WA, pendek & lembut) -->
  <audio id="snd" preload="auto"
    src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAAP//AACiTEFNRTMuMTAwA8MAAAAAAAAAAAAAAABNAAAAGAAAAGZz...">
  </audio>
  <!-- (Catatan: ini data URI mp3 pendek. Bila tidak bunyi di beberapa browser, bisa ganti file lokal .mp3 kecil) -->

  <!-- Firebase v9 (modular) -->
  <script type="module">
    // ==== Firebase imports ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, child, get, set, push, onChildAdded, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ==== Config (punyamu) ====
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    // ==== Init ====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ==== Helpers ====
    const $ = q => document.querySelector(q);
    const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
    const nav = p => location.href = p;

    // State
    let me = null;          // {uid, username, avatar}
    let mode = 'global';    // 'global' | 'private'
    let currentPeer = null; // {uid, username, avatar}
    let currentRoom = null; // roomId string
    let messagesUnsub = null;

    // UI refs
    const userList = $('#userList');
    const searchUser = $('#searchUser');
    const chatBody = $('#chatBody');
    const chatTitle = $('#chatTitle');
    const chatSub = $('#chatSub');
    const chatAva = $('#chatAva');
    const msgInput = $('#msgInput');
    const btnSend = $('#btnSend');
    const btnLogout = $('#btnLogout');
    const tabGlobal = $('#tabGlobal');
    const tabPrivate = $('#tabPrivate');
    const btnGlobal = $('#btnGlobal');
    const btnPrivate = $('#btnPrivate');
    const whoMe = $('#whoMe');
    const snd = $('#snd');

    // Avatar modal refs
    const modal = $('#profileModal');
    const btnProfile = $('#btnProfile');
    const btnCloseProfile = $('#btnCloseProfile');
    const btnSaveProfile = $('#btnSaveProfile');
    const btnUpload = $('#btnUpload');
    const meFile = $('#meFile');
    const meAva = $('#meAva');
    const meName = $('#meName');
    const avaChoices = $('#avaChoices');

    // Avatar presets (anime cute)
    const PRESETS = [
      "https://i.imgur.com/3k9d8h3.png",
      "https://i.imgur.com/0m7pQnq.png",
      "https://i.imgur.com/3n0Q8c7.png",
      "https://i.imgur.com/3xZ0kXv.png",
      "https://i.imgur.com/7m2m4mB.png",
      "https://i.imgur.com/bkqvQvU.png",
      "https://i.imgur.com/5q2YzXm.png",
      "https://i.imgur.com/6x2vQ1y.png"
    ];
    let chosenPreset = null;
    function renderPresetGrid(selUrl){
      avaChoices.innerHTML = '';
      PRESETS.forEach(url=>{
        const im = el('img',{src:url});
        if(selUrl && url===selUrl) im.classList.add('sel');
        im.onclick=()=>{
          chosenPreset=url;
          [...avaChoices.querySelectorAll('img')].forEach(i=>i.classList.remove('sel'));
          im.classList.add('sel');
          meAva.src = url;
        };
        avaChoices.appendChild(im);
      });
    }

    // Tabs switch
    function setMode(m){
      mode = m;
      tabGlobal.classList.toggle('active', m==='global');
      tabPrivate.classList.toggle('active', m==='private');
      btnGlobal.classList.toggle('active', m==='global');
      btnPrivate.classList.toggle('active', m==='private');
      chatBody.innerHTML='';
      msgInput.value='';
      if(m==='global'){
        currentRoom=null; currentPeer=null;
        chatTitle.textContent='Global Chat';
        chatSub.textContent='Semua pemain';
        chatAva.src='https://i.imgur.com/sg1m2mM.png';
        startGlobalStream();
      }else{
        stopStream();
        chatTitle.textContent='Pilih kontak';
        chatSub.textContent='Private chat';
        chatAva.src='';
      }
    }

    tabGlobal.onclick=()=>setMode('global');
    tabPrivate.onclick=()=>setMode('private');
    btnGlobal.onclick=()=>setMode('global');
    btnPrivate.onclick=()=>setMode('private');

    // Stream helpers
    function stopStream(){
      if(messagesUnsub){ messagesUnsub(); messagesUnsub=null; }
    }

    function scrollBottom(){
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function fmtTime(ts){
      const d=new Date(ts);
      return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    }

    // Render bubble
    function renderMsg(m){
      const mine = m.uid===me.uid;
      const box = el('div',{className:'b '+(mine?'me':'them')});
      box.textContent = m.text;
      const meta = el('div',{className:'meta'});
      meta.innerHTML = `<img src="${m.avatar||''}" class="ava" style="width:18px;height:18px;border-radius:50%;"> 
                        <span>${m.from}</span> ¬∑ <span>${fmtTime(m.timestamp||Date.now())}</span>
                        ${mine ? `<span class="ticks">${m.seenBy && Object.keys(m.seenBy).length>1 ? '‚úì‚úì' : '‚úì'}</span>` : ''}`;
      box.appendChild(meta);
      chatBody.appendChild(box);
      scrollBottom();
    }

    // Global stream
    function startGlobalStream(){
      stopStream();
      const q = ref(db,'chat');
      messagesUnsub = onChildAdded(q, snap=>{
        const m = snap.val();
        renderMsg(m);
        if(m.uid!==me.uid) try{ snd.currentTime=0; snd.play(); }catch{}
      });
    }

    // Private stream
    function startPrivateStream(roomId, peer){
      stopStream();
      currentRoom = roomId;
      currentPeer = peer;
      chatBody.innerHTML='';
      chatTitle.textContent = peer.username || peer.email || 'Teman';
      chatSub.textContent = 'Private chat';
      chatAva.src = peer.avatar || '';

      // set membership (idempotent)
      set(ref(db,`privateChat/${roomId}/members/${me.uid}`), true);
      set(ref(db,`privateChat/${roomId}/members/${peer.uid}`), true);

      const q = ref(db,`privateChat/${roomId}/messages`);
      messagesUnsub = onChildAdded(q, snap=>{
        const m = snap.val();
        renderMsg(m);
        // read receipt: tandai sudah dilihat
        if(m.uid!==me.uid){
          update(child(ref(db,`privateChat/${roomId}/messages`), snap.key), {
            [`seenBy/${me.uid}`]: true
          });
          try{ snd.currentTime=0; snd.play(); }catch{}
        }
      });
    }

    // Kirim pesan
    async function send(){
      const txt = msgInput.value.trim();
      if(!txt) return;
      const payload = {
        uid: me.uid,
        from: me.username || me.email || 'Player',
        avatar: me.avatar || '',
        text: txt,
        timestamp: Date.now()
      };
      if(mode==='global'){
        await push(ref(db,'chat'), payload);
      }else if(currentRoom){
        await push(ref(db,`privateChat/${currentRoom}/messages`), payload);
      }else{
        alert('Pilih kontak dulu pada tab Private'); return;
      }
      msgInput.value='';
    }
    btnSend.onclick = send;
    msgInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); send(); }
    });

    // Build roomId (berurutan supaya konsisten)
    function roomIdFor(a,b){
      return a<b ? `room_${a}_${b}` : `room_${b}_${a}`;
    }

    // Load daftar user
    function loadUsers(){
      onValue(ref(db,'users'), snap=>{
        const term = (searchUser.value||'').toLowerCase();
        userList.innerHTML='';
        snap.forEach(ch=>{
          if(!ch.exists()) return;
          const u = ch.val(); const id = ch.key;
          if(id===me.uid) return; // skip diri sendiri
          const nm = (u.username||u.email||'Player').toLowerCase();
          if(term && !nm.includes(term)) return;
          const it = el('div',{className:'item'});
          it.innerHTML = `<img class="ava" src="${u.avatar||''}" alt="">
                          <div>
                            <div style="font-weight:700">${u.username||u.email||'Player'}</div>
                            <div class="small">${u.email||''}</div>
                          </div>`;
          it.onclick=()=>{
            setMode('private');
            startPrivateStream( roomIdFor(me.uid,id), {uid:id, username:u.username||u.email, avatar:u.avatar||''} );
          };
          userList.appendChild(it);
        });
      });
    }
    searchUser.addEventListener('input', loadUsers);

    // Profile modal
    btnProfile.onclick = ()=>{ modal.style.display='grid'; renderPresetGrid(me?.avatar); meAva.src = me?.avatar||''; meName.value = me?.username||''; };
    btnCloseProfile.onclick = ()=> modal.style.display='none';
    btnUpload.onclick = ()=> meFile.click();
    meFile.onchange = async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      // upload ke storage
      const r = sRef(storage, `avatars/${me.uid}.jpg`);
      await uploadBytes(r, f);
      const url = await getDownloadURL(r);
      meAva.src = url;
      chosenPreset = null; // pakai upload
    };
    btnSaveProfile.onclick = async ()=>{
      const username = meName.value.trim() || me.email;
      let avatarUrl = meAva.src || '';
      if(chosenPreset) avatarUrl = chosenPreset;
      await update(ref(db,`users/${me.uid}`), { username, avatar: avatarUrl });
      me.username = username; me.avatar = avatarUrl;
      whoMe.textContent = `${me.username} (${me.email})`;
      modal.style.display='none';
    };

    // Logout
    btnLogout.onclick = ()=> signOut(auth).then(()=>nav('login.html'));

    // ===== Auth & bootstrap =====
    onAuthStateChanged(auth, async (u)=>{
      if(!u){ nav('login.html'); return; }
      // Pastikan profile ada
      const us = await get(ref(db,`users/${u.uid}`));
      let profile = us.exists()? us.val() : null;
      if(!profile){
        // profil baru
        profile = {
          email: u.email,
          username: (u.email||'').split('@')[0],
          avatar: PRESETS[ Math.floor(Math.random()*PRESETS.length) ]
        };
        await set(ref(db,`users/${u.uid}`), profile);
      }
      me = { uid: u.uid, email: u.email, username: profile.username, avatar: profile.avatar };
      whoMe.textContent = `${me.username} (${me.email})`;
      meAva.src = me.avatar||'';
      chatAva.src = 'https://i.imgur.com/sg1m2mM.png';
      chatTitle.textContent = 'Global Chat';
      chatSub.textContent = 'Semua pemain';

      // Mulai
      setMode('global');     // aktifkan stream global
      loadUsers();           // isi daftar user
    });
  </script>
</body>
</html>
