<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat Global & Private (v9)</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #chatBox { width: 100%; height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: 5px; margin-bottom: 10px; }
    #messageInput { width: 65%; }
    #sendBtn { width: 20%; }
    #targetSelect { width: 30%; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>💬 Chat</h2>

  <label for="targetSelect">Pilih tujuan:</label>
  <select id="targetSelect">
    <option value="global">🌍 Global Chat</option>
  </select>

  <div id="chatBox"></div>

  <input type="text" id="messageInput" placeholder="Ketik pesan...">
  <button id="sendBtn">Kirim</button>

  <!-- Firebase v9 CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, onDisconnect, onValue, push, serverTimestamp, child, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ✅ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a",
      measurementId: "G-TWGGSJRX26"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);

    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentRoom = "chat"; // default global chat
    let user = null;

    const chatBox = document.getElementById("chatBox");
    const targetSelect = document.getElementById("targetSelect");
    const sendBtn = document.getElementById("sendBtn");
    const input = document.getElementById("messageInput");

    // ✅ Sign in anonymous
    signInAnonymously(auth).catch(console.error);

    onAuthStateChanged(auth, (u) => {
      if (u) {
        user = u;

        // simpan user online
        set(ref(db, "users/" + user.uid), {
          uid: user.uid,
          online: true,
          lastSeen: serverTimestamp()
        });
        onDisconnect(ref(db, "users/" + user.uid)).remove();

        loadUsers();
        loadMessages();
      }
    });

    // ✅ Load daftar user
    function loadUsers() {
      onValue(ref(db, "users"), (snap) => {
        targetSelect.innerHTML = '<option value="global">🌍 Global Chat</option>';
        snap.forEach((childSnap) => {
          const u = childSnap.val();
          if (u.uid !== user.uid) {
            const opt = document.createElement("option");
            opt.value = u.uid;
            opt.textContent = "👤 " + u.uid;
            targetSelect.appendChild(opt);
          }
        });
      });
    }

    // ✅ Ganti tujuan chat
    targetSelect.addEventListener("change", () => {
      chatBox.innerHTML = "";
      if (targetSelect.value === "global") {
        currentRoom = "chat";
      } else {
        const otherUid = targetSelect.value;
        currentRoom = "privateChat/" + makeRoomId(user.uid, otherUid) + "/messages";
      }
      loadMessages();
    });

    // ✅ Room unik
    function makeRoomId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    // ✅ Load pesan realtime
    function loadMessages() {
      chatBox.innerHTML = "";
      onValue(ref(db, currentRoom), (snap) => {
        chatBox.innerHTML = "";
        snap.forEach((childSnap) => {
          const msg = childSnap.val();
          const div = document.createElement("div");
          div.textContent = msg.from + ": " + msg.text;
          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    // ✅ Kirim pesan
    sendBtn.addEventListener("click", () => {
      const msg = input.value.trim();
      if (!msg || !user) return;

      const newMsg = {
        from: user.uid,
        text: msg,
        timestamp: serverTimestamp()
      };

      push(ref(db, currentRoom), newMsg)
        .then(() => { input.value = ""; })
        .catch(err => alert("Gagal kirim: " + err.message));
    });
  </script>
</body>
</html>
