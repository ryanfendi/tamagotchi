<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tamagotchi - Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { display: flex; height: 100vh; }
    .sidebar {
      width: 220px; background: #f5f5f5; border-right: 1px solid #ccc;
      padding: 10px; overflow-y: auto;
    }
    .chatbox { flex: 1; display: flex; flex-direction: column; }
    .messages { flex: 1; padding: 10px; overflow-y: auto; background: #fafafa; }
    .msg { margin: 5px 0; padding: 6px 10px; border-radius: 8px; }
    .msg.me { background: #d1ffd1; align-self: flex-end; }
    .msg.other { background: #e6e6e6; align-self: flex-start; }
    .inputBar { display: flex; padding: 10px; border-top: 1px solid #ccc; }
    input { flex: 1; padding: 8px; }
    button { padding: 8px 12px; margin-left: 5px; }
    h3 { margin: 0 0 10px; }
    .room { padding: 6px; cursor: pointer; border-bottom: 1px solid #ddd; }
    .room:hover { background: #eee; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Private Chat</h3>
      <div id="userList"></div>
    </div>

    <!-- Chat Area -->
    <div class="chatbox">
      <div class="messages" id="messages"></div>
      <div class="inputBar">
        <input id="messageInput" placeholder="Tulis pesan...">
        <button onclick="sendMessage()">Kirim</button>
      </div>
    </div>
  </div>

  <script>
    // ðŸ”¥ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
      authDomain: "tamagotchi-2be0c.firebaseapp.com",
      databaseURL: "https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
      projectId: "tamagotchi-2be0c",
      storageBucket: "tamagotchi-2be0c.firebasestorage.app",
      messagingSenderId: "202052432703",
      appId: "1:202052432703:web:cb76b50e42149a2c92998a"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let currentRoom = "chat"; // default = global chat
    let currentUser = null;

    // === LOGIN TEST (otomatis login anonymous) ===
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadGlobalChat();
        loadUserList();
      } else {
        auth.signInAnonymously();
      }
    });

    // === Load Global Chat ===
    function loadGlobalChat() {
      currentRoom = "chat";
      document.getElementById("messages").innerHTML = "";
      db.ref("chat").off();
      db.ref("chat").on("child_added", snap => {
        showMessage(snap.val());
      });
    }

    // === Load Private Chat ===
    function loadPrivateChat(otherUid) {
      const roomId = currentUser.uid < otherUid ? currentUser.uid+"_"+otherUid : otherUid+"_"+currentUser.uid;
      currentRoom = "privateChat/"+roomId+"/messages";

      document.getElementById("messages").innerHTML = "";
      db.ref(currentRoom).off();
      db.ref(currentRoom).on("child_added", snap => {
        showMessage(snap.val());
      });

      // pastikan anggota room tercatat
      db.ref("privateChat/"+roomId+"/members/"+currentUser.uid).set(true);
      db.ref("privateChat/"+roomId+"/members/"+otherUid).set(true);
    }

    // === Tampilkan Pesan ===
    function showMessage(data) {
      const div = document.createElement("div");
      div.className = "msg " + (data.from === currentUser.uid ? "me" : "other");
      div.textContent = data.text;
      document.getElementById("messages").appendChild(div);
      div.scrollIntoView();
    }

    // === Kirim Pesan ===
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const msg = input.value.trim();
      if (!msg) return;

      const newMsg = {
        from: currentUser.uid,
        text: msg,
        timestamp: Date.now()
      };

      db.ref(currentRoom).push(newMsg)
        .then(() => input.value = "")
        .catch(err => alert("Error: " + err.message));
    }

    // === Load daftar user (dummy dari 'users') ===
    function loadUserList() {
      db.ref("users").on("value", snap => {
        const userListDiv = document.getElementById("userList");
        userListDiv.innerHTML = "";
        snap.forEach(child => {
          if (child.key !== currentUser.uid) {
            const div = document.createElement("div");
            div.className = "room";
            div.textContent = child.val().username || child.val().email || child.key;
            div.onclick = () => loadPrivateChat(child.key);
            userListDiv.appendChild(div);
          }
        });
      });
    }
  </script>
</body>
</html>
