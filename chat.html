<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat ‚Äî Tamagotchi</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif}
  #chatWrap{max-width:700px;margin:20px auto;text-align:center}
  #chatBox{background:#101a2b;height:320px;overflow-y:auto;padding:10px;margin:10px;border-radius:8px;text-align:left}
  input,button{padding:8px;margin:4px;border-radius:8px;border:0}
  button{background:#10b981;color:#fff;font-weight:bold;cursor:pointer}
</style>
</head>
<body>
<!-- Proteksi -->
<script>
  (function(){
    const current = localStorage.getItem('currentPlayer');
    if(!current){ alert('Silakan login terlebih dahulu'); location.href='login.html'; return; }
    const players = JSON.parse(localStorage.getItem('players')||'{}');
    if(!players[current]){ localStorage.removeItem('currentPlayer'); alert('Akun tidak ditemukan. Silakan login kembali.'); location.href='login.html'; }
  })();
</script>

<div id="chatWrap">
  <h2>üí¨ Chat Global</h2>
  <div id="chatBox"></div>
  <div>
    <input id="msg" placeholder="Ketik pesan..." style="width:70%">
    <button onclick="sendMsg()">Kirim</button>
  </div>
  <div style="margin-top:10px;">
    <button onclick="goTo('index.html')">üè† Home</button>
  </div>
</div>

<script>
let chats = JSON.parse(localStorage.getItem('chats')||'[]');
const current = localStorage.getItem('currentPlayer');

function sendMsg(){
  const text = (document.getElementById('msg').value||'').trim();
  if(!text) return;
  chats.push({ user: current, text, time: new Date().toLocaleTimeString() });
  localStorage.setItem('chats', JSON.stringify(chats));
  document.getElementById('msg').value = '';
  renderChat();
}

function renderChat(){
  const box = document.getElementById('chatBox');
  box.innerHTML = '';
  chats.forEach(c=>{
    const p = document.createElement('p');
    p.innerHTML = `<b>${c.user}</b>: ${escapeHtml(c.text)} <small>${c.time}</small>`;
    box.appendChild(p);
  });
  box.scrollTop = box.scrollHeight;
}

// sederhana untuk cegah HTML injection di chat (client-side only)
function escapeHtml(str){
  return str.replace(/[&<>"']/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
}

renderChat();
function goTo(p){ location.href=p; }
</script>
</body>
</html>
