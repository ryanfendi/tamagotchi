<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marketplace ‚Äî Tamagotchi</title>
<style>
:root{--bg:#071726;--accent:#10b981;--muted:#9fb3b5}
html,body{margin:0;padding:0;background:var(--bg);font-family:system-ui,Arial;color:#e6eef6}
.wrap{max-width:900px;margin:20px auto;padding:16px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
h2{margin-top:0}
.item{background:#101a2b;padding:12px;border-radius:8px;margin-top:10px}
button{background:linear-gradient(180deg,var(--accent),#06a77a);border:0;color:#042018;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700;margin:4px}
button.secondary{background:linear-gradient(180deg,#06b6d4,#0891b2)}
a.link{display:inline-block;background:#06b6d4;padding:8px 10px;border-radius:8px;color:#042018;text-decoration:none;margin:4px}
.small{font-size:13px;color:var(--muted)}
.offers{background:#0b1b29;margin-top:6px;padding:6px;border-radius:6px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h2>üõí Marketplace</h2>
    <div class="small">Player: <strong id="playerName">‚Äî</strong> | Coin: <span id="coinText">0</span></div>

    <div id="marketList" style="margin-top:14px">Loading...</div>

    <div style="margin-top:16px">
      <a class="link" href="index.html">‚¨Ö Game</a>
      <a class="link" href="inventory.html">üì¶ Inventory</a>
      <a class="link" href="leaderboard.html">üèÜ Leaderboard</a>
      <a class="link" href="chat.html">üí¨ Chat</a>
    </div>
  </div>
</div>

<script>
function loadPlayers(){return JSON.parse(localStorage.getItem('players')||'{}');}
function savePlayers(p){localStorage.setItem('players',JSON.stringify(p));}
function getCurrentUsername(){return (localStorage.getItem('currentPlayer')||'').toString().trim().toLowerCase();}
const players=loadPlayers();
const currentUsername=getCurrentUsername();
if(!currentUsername||!players[currentUsername]){localStorage.removeItem('currentPlayer');location.href='login.html';}
let currentPlayer=players[currentUsername];
const playerNameEl=document.getElementById('playerName');
const coinText=document.getElementById('coinText');
const marketList=document.getElementById('marketList');
function initUI(){
  playerNameEl.textContent=currentUsername;
  coinText.textContent=currentPlayer.coins||0;
  renderMarket();
}
function loadMarket(){return JSON.parse(localStorage.getItem('market')||'{}');}
function saveMarket(m){localStorage.setItem('market',JSON.stringify(m));}

function renderMarket(){
  const market=loadMarket();
  const keys=Object.keys(market);
  if(keys.length===0){marketList.innerHTML='<div class="small">Belum ada item dijual.</div>';return;}
  marketList.innerHTML=keys.map(id=>{
    const itm=market[id];
    const isSeller=(itm.seller===currentUsername);
    let html=`
      <div class="item">
        <div><strong>${itm.item.name}</strong> ‚Ä¢ Lv ${itm.item.level||1} ‚Ä¢ ‚ù§Ô∏è ${itm.item.health||1000}</div>
        <div class="small">Harga: ${itm.price} | Seller: ${itm.seller}</div>
    `;
    if(isSeller){
      html+=`<div>
        <button onclick="removeItem('${id}')">Hapus</button>
      </div>`;
      if(itm.offers&&itm.offers.length>0){
        html+=`<div class="offers"><strong>Tawaran:</strong>`;
        itm.offers.forEach((of,i)=>{
          html+=`<div>${of.buyer}: ${of.price}
            <button onclick="acceptOffer('${id}',${i})">‚úî</button>
            <button onclick="rejectOffer('${id}',${i})">‚úñ</button>
          </div>`;
        });
        html+='</div>';
      }
    }else{
      html+=`<div>
        <button onclick="buyItem('${id}')">Beli (${itm.price})</button>
        <button class="secondary" onclick="offer('${id}')">Tawar</button>
      </div>`;
    }
    html+='</div>';
    return html;
  }).join('');
}

window.buyItem=function(id){
  const market=loadMarket();
  const itm=market[id];
  if(!itm)return;
  if((currentPlayer.coins||0)<itm.price)return alert('Coin tidak cukup.');
  currentPlayer.coins-=itm.price;
  currentPlayer.inventory=currentPlayer.inventory||[];
  currentPlayer.inventory.push(itm.item);
  const seller=players[itm.seller];
  if(seller){seller.coins=(seller.coins||0)+itm.price;}
  delete market[id];
  saveMarket(market);
  persist();
  alert('Berhasil membeli pet!');
  initUI();
};

window.offer=function(id){
  const price=parseInt(prompt('Masukkan tawaran harga:'),10);
  if(!price||price<=0)return;
  const market=loadMarket();
  const itm=market[id];
  if(!itm)return;
  itm.offers=itm.offers||[];
  itm.offers.push({buyer:currentUsername,price});
  saveMarket(market);
  renderMarket();
};

window.removeItem=function(id){
  const market=loadMarket();
  delete market[id];
  saveMarket(market);
  renderMarket();
};

window.acceptOffer=function(id,idx){
  const market=loadMarket();
  const itm=market[id];
  if(!itm||!itm.offers||!itm.offers[idx])return;
  const offer=itm.offers[idx];
  const buyer=players[offer.buyer];
  if(!buyer)return alert('Buyer tidak ditemukan.');
  if((buyer.coins||0)<offer.price)return alert('Buyer tidak punya cukup coin.');
  buyer.coins-=offer.price;
  buyer.inventory=buyer.inventory||[];
  buyer.inventory.push(itm.item);
  const seller=players[itm.seller];
  if(seller){seller.coins=(seller.coins||0)+offer.price;}
  delete market[id];
  saveMarket(market);
  savePlayers(players);
  alert('Tawaran diterima. Item berpindah ke buyer.');
  renderMarket();
};

window.rejectOffer=function(id,idx){
  const market=loadMarket();
  const itm=market[id];
  if(!itm||!itm.offers)return;
  itm.offers.splice(idx,1);
  saveMarket(market);
  renderMarket();
};

function persist(){
  const all=loadPlayers();
  all[currentUsername]=currentPlayer;
  savePlayers(all);
}
initUI();
</script>
</body>
</html>
