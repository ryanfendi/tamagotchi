<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketplace — Tamagotchi</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  .wrap{max-width:760px;margin:0 auto}
  .panel{background:#101a2b;padding:14px;border-radius:12px;margin:12px}
  .menu a,.menu button{background:#1f2937;color:#fff;text-decoration:none;padding:8px 10px;margin:4px;border-radius:10px;border:0;display:inline-block}
  button,input,select{padding:8px;border-radius:10px;border:0;margin:4px}
  button{background:#10b981;color:#042018;font-weight:700}
  .item{background:#1a2436;border-radius:10px;padding:10px;margin:8px 0;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <h2>🏪 Marketplace</h2>
  <div class="menu">
    <a href="index.html">🏠 Home</a>
    <a href="inventory.html">📦 Inventory</a>
    <a href="leaderboard.html">🏆 Leaderboard</a>
    <a href="chat.html">💬 Chat</a>
    <button onclick="logout()">🚪 Logout</button>
  </div>

  <div id="summary" class="panel"></div>

  <div class="panel">
    <h3>Daftar Jual</h3>
    <div id="marketList"></div>
  </div>

  <div class="panel">
    <h3>Transfer Coin</h3>
    <input id="toUser" placeholder="Nama penerima"/>
    <input id="amt" type="number" placeholder="Jumlah coin"/>
    <button onclick="transferCoin()">Kirim Coin</button>
  </div>

  <div class="panel">
    <h3>Transfer Pet (dari koleksi)</h3>
    <select id="selPet"></select>
    <input id="toUserPet" placeholder="Nama penerima"/>
    <button onclick="transferPet()">Kirim Pet</button>
  </div>
</div>

<script>
let players = JSON.parse(localStorage.getItem('players')||'{}');
let market = JSON.parse(localStorage.getItem('market')||'{}');
let currentUser = localStorage.getItem('lastUser');
if(!currentUser || !players[currentUser]) location.href='index.html';

function saveAll(){
  localStorage.setItem('players', JSON.stringify(players));
  localStorage.setItem('market', JSON.stringify(market));
}
function logout(){ localStorage.removeItem('lastUser'); location.href='index.html'; }

function render(){
  const me = players[currentUser];
  document.getElementById('summary').innerHTML = `
    <p><b>Player:</b> ${currentUser}</p>
    <p><b>Coin:</b> ${me.coins}</p>
    <p><b>Koleksi:</b> ${me.inventory.length} pet</p>
  `;
  document.getElementById('selPet').innerHTML =
    me.inventory.map((p,i)=>`<option value="${i}">#${i+1} — Lv ${p.level}</option>`).join('') || '<option>(kosong)</option>';

  const list = Object.entries(market);
  const box = document.getElementById('marketList');
  if(list.length===0){ box.innerHTML = '<p>Tidak ada pet di marketplace.</p>'; return; }
  box.innerHTML = list.map(([id,item])=>{
    const controls = item.seller===currentUser
      ? `<button onclick="cancelSale('${id}')">Batalkan</button>`
      : `<button onclick="buy('${id}')">Beli</button>`;
    return `
      <div class="item">
        <div><b>Pet:</b> Lv ${item.pet.level} | HP ${item.pet.hp}% | H ${item.pet.hunger}% | E ${item.pet.energy}%</div>
        <div><b>Harga:</b> ${item.price} coin</div>
        <div><b>Penjual:</b> ${item.seller}</div>
        ${controls}
      </div>
    `;
  }).join('');
}

function buy(id){
  const me=players[currentUser];
  const item=market[id];
  if(!item) return alert('Item tidak ditemukan.');
  if(me.coins < item.price) return alert('Coin tidak cukup!');
  const seller=players[item.seller];
  if(!seller) return alert('Penjual tidak ditemukan.');

  me.coins -= item.price;
  seller.coins += item.price;
  me.inventory.push(item.pet);
  delete market[id];

  saveAll(); render();
  alert('Pembelian berhasil!');
}
function cancelSale(id){
  const item=market[id];
  if(!item || item.seller!==currentUser) return alert('Tidak bisa dibatalkan.');
  players[currentUser].inventory.push(item.pet);
  delete market[id];
  saveAll(); render(); alert('Dibatalkan.');
}

function transferCoin(){
  const me=players[currentUser];
  const to=(document.getElementById('toUser').value||'').trim();
  const amt=parseInt(document.getElementById('amt').value||'0');
  if(!players[to]) return alert('Penerima tidak ditemukan.');
  if(!amt || amt<=0) return alert('Jumlah tidak valid.');
  if(me.coins<amt) return alert('Coin tidak cukup.');
  me.coins -= amt; players[to].coins = (players[to].coins||0) + amt;
  saveAll(); render(); alert('Coin terkirim!');
}

function transferPet(){
  const me=players[currentUser];
  if(!me.inventory || me.inventory.length===0) return alert('Koleksi kosong.');
  const idx=parseInt(document.getElementById('selPet').value||'-1');
  const to=(document.getElementById('toUserPet').value||'').trim();
  if(idx<0 || idx>=me.inventory.length) return alert('Pilih pet.');
  if(!players[to]) return alert('Penerima tidak ditemukan.');
  const pet=me.inventory.splice(idx,1)[0];
  players[to].inventory.push(pet);
  saveAll(); render(); alert('Pet terkirim!');
}

render();
</script>
</body>
</html>
