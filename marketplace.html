<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamagotchi ‚Äî Marketplace, Trades, Leaderboard & Chat</title>
<style>
body{background:linear-gradient(180deg,#071726,#06202a);color:#e6eef6;font-family:system-ui,Arial;margin:0;padding:18px}
.container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr;gap:12px}
.panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
.sale{padding:8px;background:#0f1724;border-radius:8px;margin-bottom:8px}
button{background:#10b981;border:0;padding:6px 10px;border-radius:6px;color:#042018;cursor:pointer;margin-left:6px}
input,select,textarea{padding:6px;border-radius:6px;border:0;width:100%}
.small{font-size:13px;color:#9fb3b5}
.audit{max-height:140px;overflow:auto;background:#071826;padding:8px;border-radius:6px;margin-top:8px}
.section{margin-bottom:12px}
.chatBox{height:220px;overflow:auto;background:#071826;padding:8px;border-radius:6px}
.message{margin-bottom:6px}
.msgFrom{font-weight:700}
</style>
</head>
<body>
<div class="container">
  <div class="panel">
    <h1>üõí Marketplace</h1>
    <div class="section">
      User: <input id="userName" placeholder="Masukkan nama (sama dgn Game)" />
      <button id="loadBtn">Load</button>
      <a href="index.html">‚Üê Game</a> <a href="inventory.html">Inventory</a>
    </div>

    <div class="section">
      <h3>Pet Listings</h3>
      <div id="listings"></div>
    </div>

    <div class="section">
      <h3>Trades (bilateral)</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="tradeTo" placeholder="To (player)"/>
        <input id="offerCoins" type="number" placeholder="Offer coins" />
        <input id="offerPetId" placeholder="Offer petId (optional)" />
        <input id="requestCoins" type="number" placeholder="Request coins" />
        <input id="requestPetId" placeholder="Request petId (optional)" />
        <button id="makeTradeBtn">Make Trade</button>
      </div>
      <div id="tradesList" style="margin-top:8px"></div>
    </div>

    <div class="section" id="leaderboardSection">
      <h3 id="leaderboardTitle">üèÜ Leaderboard</h3>
      <div class="small">Click "Refresh" to update</div>
      <button id="refreshLeaderboardBtn">Refresh</button>
      <div id="leaderboard" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="panel">
    <h2>üí¨ Chat</h2>
    <div style="margin-bottom:8px">
      <select id="chatMode"><option value="global">Global</option><option value="dm">Direct Message (DM)</option></select>
      <input id="chatTo" placeholder="Recipient (for DM)" />
    </div>
    <div class="chatBox" id="chatBox"></div>
    <div style="margin-top:8px">
      <textarea id="chatMessage" placeholder="Tulis pesan..." rows="3"></textarea>
      <button id="sendChatBtn">Send</button>
    </div>

    <div style="margin-top:12px">
      <strong>Audit (you)</strong>
      <div id="auditBox" class="audit"></div>
    </div>
  </div>
</div>

<script>
const PLAYERS_KEY = 'tama_players_v12';
const MARKET_KEY  = 'tama_market_v12';
const TRADES_KEY  = 'tama_trades_v12';
const CHAT_KEY    = 'tama_chat_v12';
function load(k){ try{return JSON.parse(localStorage.getItem(k)||'{}')}catch{return{}} }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
let players = load(PLAYERS_KEY), market = load(MARKET_KEY), trades = load(TRADES_KEY), chat = load(CHAT_KEY);
let currentUser = null;

/* load user */
document.getElementById('loadBtn').addEventListener('click', ()=>{
  const n = document.getElementById('userName').value.trim(); if(!n) return alert('Masukkan nama');
  players = load(PLAYERS_KEY); market = load(MARKET_KEY); trades = load(TRADES_KEY); chat = load(CHAT_KEY);
  if(!players[n]) return alert('Player not found (login via Game)');
  currentUser = n; renderListings(); renderTrades(); renderLeaderboard(); renderChat(); renderAudit(); document.getElementById('userName').value = currentUser;
});

/* render listings */
function renderListings(){
  market = load(MARKET_KEY); players = load(PLAYERS_KEY);
  const out = document.getElementById('listings'); out.innerHTML = '';
  const ids = Object.keys(market);
  if(ids.length===0){ out.innerHTML = '<div class="small">Marketplace kosong</div>'; return; }
  ids.forEach(id=>{
    const s = market[id];
    const offersSummary = (s.offers||[]).map(o=>`${o.buyer}:${o.price}`).join(' | ') || 'No offers';
    const div = document.createElement('div'); div.className='sale';
    div.innerHTML = `<strong>${id}</strong> ‚Äî seller: ${s.seller} ‚Äî price: ${s.price} üí∞<br>Pet: üê£ ${s.pet.name} (Lv:${s.pet.level||1})<br>
      <div class="small">Offers: ${offersSummary}</div>
      <div style="margin-top:6px">
        <button onclick="buyDirect('${id}')">Buy (pay ${s.price}üí∞)</button>
        <button onclick="makeOfferPrompt('${id}')">Tawar</button>
      </div>`;
    if(currentUser && currentUser === s.seller){
      const offersDiv = document.createElement('div'); offersDiv.style.marginTop='6px';
      (s.offers||[]).forEach((o, idx)=>{
        const row = document.createElement('div'); row.className='small';
        row.innerHTML = `${o.buyer} offered ${o.price} üí∞ <button onclick="acceptOffer('${id}',${idx})">Accept</button> <button onclick="rejectOffer('${id}',${idx})">Reject</button>`;
        offersDiv.appendChild(row);
      });
      div.appendChild(offersDiv);
    }
    out.appendChild(div);
  });
}

/* buy direct */
function buyDirect(id){
  if(!currentUser) return alert('Login dulu');
  players = load(PLAYERS_KEY); market = load(MARKET_KEY);
  const pl = players[currentUser]; if(!pl) return alert('Player not found');
  const s = market[id]; if(!s) return alert('Listing not found');
  if(s.seller === currentUser) return alert('Cannot buy your own listing');
  const price = s.price;
  if(currentUser !== 'owner' && (pl.coins||0) < price) return alert('Coin tidak cukup');
  if(currentUser !== 'owner') pl.coins -= price;
  players[s.seller].coins = (players[s.seller].coins||0) + price;
  pl.inventory = pl.inventory || []; pl.inventory.push(s.pet);
  players[currentUser].audit = players[currentUser].audit || []; players[currentUser].audit.unshift({t:Date.now(), msg:`Beli ${s.pet.name} from ${s.seller} (${price})`});
  players[s.seller].audit = players[s.seller].audit || []; players[s.seller].audit.unshift({t:Date.now(), msg:`Terjual ${s.pet.name} ke ${currentUser} (${price})`});
  delete market[id]; save(MARKET_KEY, market); save(PLAYERS_KEY, players);
  alert('Pembelian berhasil');
  renderListings(); renderTrades(); renderAudit();
}

/* offer */
function makeOfferPrompt(id){
  if(!currentUser) return alert('Login dulu');
  const offer = parseInt(prompt('Masukkan tawaran coin:'),10); if(isNaN(offer)||offer<=0) return alert('Invalid offer');
  market = load(MARKET_KEY); const s = market[id]; if(!s) return alert('Listing not found');
  s.offers = s.offers || []; s.offers.push({ buyer: currentUser, price: offer, created: Date.now() });
  players = load(PLAYERS_KEY);
  players[currentUser].audit = players[currentUser].audit || []; players[currentUser].audit.unshift({t:Date.now(), msg:`Tawar ${offer} untuk ${s.pet.name}`});
  players[s.seller].audit = players[s.seller].audit || []; players[s.seller].audit.unshift({t:Date.now(), msg:`Ada tawaran ${offer} dari ${currentUser} untuk ${s.pet.name}`});
  save(PLAYERS_KEY, players); save(MARKET_KEY, market);
  alert('Tawaran terkirim');
  renderListings(); renderAudit();
}

/* accept/reject same as prior */
function acceptOffer(listingId, idx){
  market = load(MARKET_KEY); players = load(PLAYERS_KEY);
  const s = market[listingId]; if(!s) return alert('Listing hilang');
  if(currentUser !== s.seller) return alert('Hanya seller yang bisa accept');
  const offer = s.offers && s.offers[idx]; if(!offer) return alert('Offer tidak ada');
  const buyer = players[offer.buyer]; if(!buyer) return alert('Buyer tidak ada');
  if((buyer.coins||0) < offer.price) return alert('Buyer coin tidak cukup');
  buyer.coins -= offer.price; players[s.seller].coins = (players[s.seller].coins||0) + offer.price;
  buyer.inventory = buyer.inventory || []; buyer.inventory.push(s.pet);
  buyer.audit = buyer.audit || []; buyer.audit.unshift({t:Date.now(), msg:`Pembelian diterima: ${s.pet.name} (${offer.price})`});
  players[s.seller].audit = players[s.seller].audit || []; players[s.seller].audit.unshift({t:Date.now(), msg:`Accept ${offer.price} from ${offer.buyer} for ${s.pet.name}`});
  delete market[listingId]; save(PLAYERS_KEY, players); save(MARKET_KEY, market);
  alert('Offer accepted');
  renderListings(); renderTrades(); renderAudit();
}
function rejectOffer(listingId, idx){ market = load(MARKET_KEY); const s = market[listingId]; if(!s) return; if(currentUser !== s.seller) return alert('Only seller'); const offer = s.offers && s.offers[idx]; if(!offer) return; players = load(PLAYERS_KEY); players[offer.buyer].audit = players[offer.buyer].audit||[]; players[offer.buyer].audit.unshift({t:Date.now(), msg:`Offer rejected for ${s.pet.name}`}); s.offers.splice(idx,1); save(MARKET_KEY, market); save(PLAYERS_KEY, players); renderListings(); renderAudit(); }

/* Trades (create / accept / ...) */
document.getElementById('makeTradeBtn').addEventListener('click', ()=>{
  const to = document.getElementById('tradeTo').value.trim();
  const offerCoins = parseInt(document.getElementById('offerCoins').value||0,10)||0;
  const offerPet = (document.getElementById('offerPetId').value||'').trim()||null;
  const reqCoins = parseInt(document.getElementById('requestCoins').value||0,10)||0;
  const reqPet = (document.getElementById('requestPetId').value||'').trim()||null;
  if(!currentUser) return alert('Login dulu');
  players = load(PLAYERS_KEY);
  if(!players[to]) return alert('Target player tidak ditemukan');
  const me = players[currentUser];
  if(me.coins < offerCoins) return alert('Anda tidak punya coin yang ditawarkan');
  if(offerPet && !me.inventory.some(p=>p.id===offerPet)) return alert('Anda tidak punya pet yang ditawarkan');
  trades = load(TRADES_KEY);
  const id = 'trade_' + Math.random().toString(36).slice(2,9);
  trades[id] = { id, from: currentUser, to, offer:{coins:offerCoins, petId:offerPet}, request:{coins:reqCoins, petId:reqPet}, status:'pending', created:Date.now() };
  save(TRADES_KEY, trades);
  players[to].audit = players[to].audit || []; players[to].audit.unshift({t:Date.now(), msg:`Trade offer from ${currentUser}`});
  save(PLAYERS_KEY, players); alert('Trade offer terkirim'); renderTrades(); renderAudit();
});

/* render trades */
function renderTrades(){
  trades = load(TRADES_KEY); players = load(PLAYERS_KEY);
  const out = document.getElementById('tradesList'); out.innerHTML = '';
  const keys = Object.keys(trades);
  if(keys.length===0){ out.innerHTML = '<div class="small">No trades</div>'; return; }
  keys.forEach(k=>{
    const t = trades[k];
    const div = document.createElement('div'); div.className='sale';
    div.innerHTML = `<strong>${t.id}</strong> ‚Äî ${t.from} ‚Üí ${t.to} ‚Äî status: ${t.status}
      <div class="small">Offer: ${t.offer.coins}üí∞ ${t.offer.petId? ' + pet:'+t.offer.petId : ''} | Request: ${t.request.coins}üí∞ ${t.request.petId? ' + pet:'+t.request.petId : ''}</div>`;
    if(currentUser && currentUser===t.to && t.status==='pending'){ const a=document.createElement('button'); a.textContent='Accept'; a.onclick=()=> acceptTrade(t.id); const r=document.createElement('button'); r.textContent='Reject'; r.onclick=()=> { trades = load(TRADES_KEY); trades[t.id].status='rejected'; save(TRADES_KEY, trades); renderTrades(); renderAudit(); }; div.appendChild(a); div.appendChild(r); }
    if(currentUser && currentUser===t.from && t.status==='pending'){ const c=document.createElement('button'); c.textContent='Cancel'; c.onclick=()=>{ trades=load(TRADES_KEY); trades[t.id].status='cancelled'; save(TRADES_KEY,trades); renderTrades(); renderAudit(); }; div.appendChild(c); }
    out.appendChild(div);
  });
}
function acceptTrade(id){
  trades = load(TRADES_KEY); players = load(PLAYERS_KEY);
  const t = trades[id]; if(!t) return alert('Trade not found');
  if(currentUser !== t.to) return alert('Only recipient can accept');
  const a = players[t.from], b = players[t.to];
  if(!a||!b) return alert('Players missing');
  if(t.offer.coins && (a.coins||0) < t.offer.coins) return alert('Offeror lacks coins');
  if(t.request.coins && (b.coins||0) < t.request.coins) return alert('Recipient lacks requested coins');
  if(t.offer.petId && !a.inventory.some(p=>p.id===t.offer.petId)) return alert('Offeror lacks pet');
  if(t.request.petId && !b.inventory.some(p=>p.id===t.request.petId)) return alert('Recipient lacks requested pet');
  if(t.offer.coins){ a.coins -= t.offer.coins; b.coins = (b.coins||0) + t.offer.coins; }
  if(t.request.coins){ b.coins -= t.request.coins; a.coins = (a.coins||0) + t.request.coins; }
  if(t.offer.petId){ const idx=a.inventory.findIndex(p=>p.id===t.offer.petId); if(idx>-1){ const pet=a.inventory.splice(idx,1)[0]; b.inventory.push(pet); } }
  if(t.request.petId){ const idx2=b.inventory.findIndex(p=>p.id===t.request.petId); if(idx2>-1){ const pet2=b.inventory.splice(idx2,1)[0]; a.inventory.push(pet2); } }
  t.status='accepted';
  a.audit = a.audit || []; a.audit.unshift({t:Date.now(), msg:`Trade executed with ${b.name}`});
  b.audit = b.audit || []; b.audit.unshift({t:Date.now(), msg:`Trade executed with ${a.name}`});
  save(PLAYERS_KEY, players); save(TRADES_KEY, trades);
  alert('Trade executed'); renderTrades(); renderListings(); renderAudit();
}

/* Leaderboard functions */
function buildLeaderboard(){
  players = load(PLAYERS_KEY);
  const arr = Object.values(players).map(p=> { const pet = (p.inventory||[])[0] || null; return { name:p.name, level: pet?pet.level||1:0, petName: pet?pet.name:'-', food:p.foodCount||0 }; });
  arr.sort((a,b)=> (b.level - a.level));
  return arr;
}
function renderLeaderboard(){
  const out = document.getElementById('leaderboard'); out.innerHTML=''; const list = buildLeaderboard();
  list.forEach((p,i)=>{ const div=document.createElement('div'); div.className='sale'; div.innerHTML = `${i+1}. <strong>${p.name}</strong> ‚Äî Lv ${p.level} ‚Ä¢ Pet: ${p.petName} ‚Ä¢ Food:${p.food}`; out.appendChild(div); });
}
document.getElementById('refreshLeaderboardBtn').addEventListener('click', renderLeaderboard);

/* Chat: store messages as {id, from, to (null for global), text, t} */
function sendMessage(from, to, text){
  if(!from) return alert('Login dulu');
  chat = load(CHAT_KEY);
  chat.msgs = chat.msgs || [];
  chat.msgs.push({ id: 'm_'+Math.random().toString(36).slice(2,8), from, to: to||null, text, t: Date.now() });
  save(CHAT_KEY, chat);
}
document.getElementById('sendChatBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('chatMessage').value.trim(); if(!txt) return;
  const mode = document.getElementById('chatMode').value;
  const to = document.getElementById('chatTo').value.trim();
  if(mode === 'dm' && !to) return alert('Masukkan recipient untuk DM');
  sendMessage(currentUser, mode==='dm'?to:null, txt);
  document.getElementById('chatMessage').value='';
  renderChat();
});

/* render chat: show global + DM involving currentUser */
function renderChat(){
  chat = load(CHAT_KEY); players = load(PLAYERS_KEY);
  const box = document.getElementById('chatBox'); box.innerHTML = '';
  const msgs = (chat.msgs||[]).slice(-200);
  msgs.forEach(m=>{
    // visibility: global or DM to/from currentUser
    if(m.to && currentUser){
      if(!(m.to === currentUser || m.from === currentUser)) return;
    } else {
      // global visible to all
    }
    const d = new Date(m.t).toLocaleTimeString();
    const div = document.createElement('div'); div.className='message';
    div.innerHTML = `<div class="msgFrom">${m.from} <span class="small">[${d}]</span>${m.to?(' ‚Üí '+m.to):''}</div><div>${m.text}</div>`;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

/* Audit for current user */
function renderAudit(){
  const box = document.getElementById('auditBox'); box.innerHTML = '';
  if(!currentUser) return;
  players = load(PLAYERS_KEY);
  const pl = players[currentUser]; if(!pl || !pl.audit) { box.innerHTML = '<div class="small">No audit</div>'; return; }
  pl.audit.slice(0,50).forEach(a=>{ const d=new Date(a.t).toLocaleString(); const r=document.createElement('div'); r.className='small'; r.textContent=`${d} ‚Äî ${a.msg}`; box.appendChild(r); });
}

/* polling updates for chat/listings/trades */
setInterval(()=>{ renderListings(); renderTrades(); renderLeaderboard(); renderChat(); renderAudit(); }, 2000);

/* initial render */
renderListings(); renderTrades(); renderLeaderboard(); renderChat();
</script>
</body>
</html>
