<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketplace</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center;padding:16px}
  .item{background:#0f172a;border-radius:10px;padding:10px;margin:8px auto;max-width:700px;display:flex;justify-content:space-between;align-items:center}
  button{padding:8px 10px;border:0;border-radius:8px;background:#10b981;color:#06261f;font-weight:700;cursor:pointer}
</style>
</head>
<body>
  <h2>🏪 Marketplace</h2>
  <div id="me">Memuat…</div>
  <div id="list"></div>
  <button onclick="nav('game.html')">⬅️ Kembali</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const cfg={apiKey:"AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",authDomain:"tamagotchi-2be0c.firebaseapp.com",databaseURL:"https://tamagotchi-2be0c-default-rtdb.firebaseio.com",projectId:"tamagotchi-2be0c",storageBucket:"tamagotchi-2be0c.firebasestorage.app",messagingSenderId:"202052432703",appId:"1:202052432703:web:cb76b50e42149a2c92998a",measurementId:"G-TWGGSJRX26"};
    firebase.initializeApp(cfg); const auth=firebase.auth(), db=firebase.database();
    let uid, prof;

    function nav(p){ location.href=p; }

    function renderMarket(snap){
      const list=document.getElementById('list'); list.innerHTML='';
      snap.forEach(ch=>{
        const it=ch.val(); const div=document.createElement('div'); div.className='item';
        div.innerHTML=`<div>🐾 <b>${it.pet.name}</b> (Lv ${it.pet.level})<br>Harga: <b>${it.price}</b> • Penjual: ${it.sellerName}</div>
          <div>${it.sellerUid!==uid?`<button onclick="buy('${it.id}',${it.price})">Beli</button>`:`<button onclick="pull('${it.id}',${JSON.stringify(it.pet)})">Tarik</button>`}</div>`;
        list.appendChild(div);
      });
    }

    async function buy(id, price){
      if(prof.coins<price) return alert('Coin tidak cukup');
      const itemSnap=await db.ref('market/'+id).once('value');
      if(!itemSnap.exists()) return alert('Item sudah terjual');
      const it=itemSnap.val();
      await db.ref('users/'+uid+'/coins').transaction(c=>(Number(c)||0)-price);
      await db.ref('users/'+it.sellerUid+'/coins').transaction(c=>(Number(c)||0)+price);
      const invSnap = await db.ref('users/'+uid+'/inventory').once('value');
      const inv = invSnap.val()||[];
      inv.push(it.pet);
      await db.ref('users/'+uid+'/inventory').set(inv);
      await db.ref('market/'+id).remove();
      alert('Berhasil membeli pet');
    }

    async function pull(id, pet){
      // Tarik kembali ke inventory
      const invSnap = await db.ref('users/'+uid+'/inventory').once('value');
      const inv = invSnap.val()||[];
      inv.push(pet);
      await db.ref('users/'+uid+'/inventory').set(inv);
      await db.ref('market/'+id).remove();
      alert('Item ditarik');
    }

    auth.onAuthStateChanged(async u=>{
      if(!u){ location.href='index.html'; return; }
      uid=u.uid;
      const s=await db.ref('users/'+uid).once('value');
      prof=s.val(); document.getElementById('me').textContent=`👤 ${prof.username} • 💰 ${Number(prof.coins).toFixed(2)}`;
      db.ref('market').on('value',renderMarket);
    });
  </script>
</body>
</html>
