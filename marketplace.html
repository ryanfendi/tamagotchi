<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketplace</title>
<style>
body{ background:#0b1220; color:#fff; font-family:sans-serif; text-align:center; }
input,button{margin:5px;padding:8px;}
</style>
</head>
<body>
<h1>üõí Marketplace</h1>
<h3>Transfer Coin</h3>
<input id="toUser" placeholder="Kepada siapa">
<input id="amount" type="number" placeholder="Jumlah">
<button onclick="sendCoin()">Kirim</button>

<h3>Jual Pet</h3>
<input id="sellPrice" type="number" placeholder="Harga pet">
<button onclick="sellPet()">Jual Pet</button>

<div id="market"></div>
<button onclick="back()">‚¨ÖÔ∏è Kembali</button>

<script>
let players=JSON.parse(localStorage.getItem("players")||"{}");
let session=JSON.parse(localStorage.getItem("session")||"{}");
if(!session.currentUser) location.href="login.html";
let me=players[session.currentUser];

function sendCoin(){
  let to=document.getElementById("toUser").value.trim();
  let amt=parseInt(document.getElementById("amount").value);
  if(!players[to]) return alert("User tidak ditemukan");
  if(me.coins<amt) return alert("Coin tidak cukup");
  me.coins-=amt; players[to].coins+=amt;
  save(); alert("Transfer berhasil");
}
function sellPet(){
  let price=parseInt(document.getElementById("sellPrice").value);
  if(!me.pet.alive) return alert("Pet mati tidak bisa dijual");
  localStorage.setItem("marketPet",JSON.stringify({owner:session.currentUser,pet:me.pet,price}));
  alert("Pet dijual di marketplace!");
  renderMarket();
}
function buyPet(owner){
  let data=JSON.parse(localStorage.getItem("marketPet"));
  if(!data||data.owner!==owner) return;
  if(me.coins<data.price) return alert("Coin tidak cukup!");
  me.coins-=data.price; players[owner].coins+=data.price;
  me.pet=data.pet; 
  delete players[owner].pet; // pet pindah
  localStorage.removeItem("marketPet");
  save(); alert("Berhasil beli pet");
  renderMarket();
}
function renderMarket(){
  let data=JSON.parse(localStorage.getItem("marketPet"));
  if(data){
    document.getElementById("market").innerHTML=`<p>${data.owner} menjual pet Lv.${data.pet.level} seharga üí∞${data.price}</p><button onclick="buyPet('${data.owner}')">Beli</button>`;
  } else {
    document.getElementById("market").innerHTML="Tidak ada pet dijual";
  }
}
function save(){ localStorage.setItem("players",JSON.stringify(players)); }
function back(){ location.href="menu.html"; }
renderMarket();
</script>
</body>
</html>
