<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketplace - Tamagotchi</title>
<style>
body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center;}
.panel{background:#101a2b;padding:10px;margin:10px auto;width:90%;max-width:600px;border-radius:8px;}
button{background:#10b981;border:none;padding:8px;margin:4px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;}
.offer-list{background:#1a2436;padding:8px;margin-top:6px;border-radius:8px;}
</style>
</head>
<body>
<h2>🛒 Marketplace</h2>
<div id="marketList" class="panel"></div>
<div style="margin-top:10px;">
    <button onclick="goTo('index.html')">🏠 Home</button>
    <button onclick="goTo('inventory.html')">📦 Inventory</button>
    <button onclick="goTo('leaderboard.html')">🏆 Leaderboard</button>
    <button onclick="goTo('chat.html')">💬 Chat</button>
    <button onclick="logout()">🚪 Logout</button>
</div>
<script>
let currentPlayerName = localStorage.getItem("currentPlayer");
if(!currentPlayerName) location.href="login.html";
let players = JSON.parse(localStorage.getItem("players")||"{}");
let player = players[currentPlayerName];

function renderMarket(){
    const market=JSON.parse(localStorage.getItem("market")||"{}");
    const div=document.getElementById("marketList");
    div.innerHTML="";
    if(Object.keys(market).length===0){div.innerHTML="<p>Tidak ada pet dijual.</p>";return;}
    for(let id in market){
        let sale=market[id];
        div.innerHTML+=`
        <div class="offer-list">
            <b>${sale.pet.name}</b> | Level: ${sale.pet.level}<br>
            Harga: ${sale.price}<br>
            Penjual: ${sale.seller}<br>
            ${sale.seller!==player.name?`
            <button onclick="buy('${id}')">Beli</button>
            <button onclick="offer('${id}')">Tawar</button>
            `:''}
            ${sale.seller===player.name?`
            <h4>Tawaran:</h4>
            ${sale.offers.length===0?'<p>Tidak ada tawaran</p>':sale.offers.map((o,i)=>`
                <p>${o.buyer} menawar ${o.price}
                <button onclick="accept('${id}',${i})">Terima</button>
                <button onclick="reject('${id}',${i})">Tolak</button></p>`).join('')}
            `:''}
        </div>`;
    }
}

function buy(id){
    let market=JSON.parse(localStorage.getItem("market")||"{}");
    let sale=market[id];
    if(player.coins<sale.price){alert("Coin tidak cukup!");return;}
    player.coins-=sale.price;
    player.inventory.push(sale.pet);
    players[player.name]=player;
    let seller=players[sale.seller];
    seller.coins+=sale.price;
    players[sale.seller]=seller;
    delete market[id];
    save(market);
    alert("Pembelian berhasil!");
    renderMarket();
}

function offer(id){
    const price=prompt("Masukkan harga tawaran:");
    if(!price||isNaN(price))return;
    let market=JSON.parse(localStorage.getItem("market")||"{}");
    market[id].offers.push({buyer:player.name,price:parseInt(price)});
    localStorage.setItem("market",JSON.stringify(market));
    alert("Tawaran dikirim!");
    renderMarket();
}

function accept(id,i){
    let market=JSON.parse(localStorage.getItem("market")||"{}");
    let sale=market[id];
    let offer=sale.offers[i];
    let buyer=players[offer.buyer];
    if(buyer.coins<offer.price){alert("Buyer coin tidak cukup!");return;}
    buyer.coins-=offer.price;
    buyer.inventory.push(sale.pet);
    players[buyer.name]=buyer;
    player.coins+=offer.price;
    delete market[id];
    save(market);
    alert("Tawaran diterima!");
    renderMarket();
}

function reject(id,i){
    let market=JSON.parse(localStorage.getItem("market")||"{}");
    market[id].offers.splice(i,1);
    localStorage.setItem("market",JSON.stringify(market));
    renderMarket();
}

function save(market){
    localStorage.setItem("market",JSON.stringify(market));
    localStorage.setItem("players",JSON.stringify(players));
}

function logout(){
    localStorage.removeItem("currentPlayer");
    location.href="login.html";
}

function goTo(p){location.href=p;}
renderMarket();
</script>
</body>
</html>
