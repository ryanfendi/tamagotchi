<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamagotchi Online — Marketplace</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  .wrap{max-width:860px;margin:0 auto;padding:12px}
  .panel{background:#101a2b;border-radius:12px;padding:14px;margin:10px}
  .menu a,.menu button{background:#1f2937;color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px;border:0;display:inline-block;margin:4px}
  button,input{padding:10px;border-radius:10px;border:0;margin:4px}
  button{background:#10b981;color:#042018;font-weight:700}
  .item{background:#1a2436;border-radius:10px;padding:10px;margin:8px 0;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <h2>🏪 Marketplace</h2>
  <div class="menu">
    <a href="index.html">🏠 Home</a>
    <a href="inventory.html">📦 Inventory</a>
    <a href="leaderboard.html">🏆 Leaderboard</a>
    <a href="chat.html">💬 Chat</a>
    <button id="btnLogout">🚪 Logout</button>
  </div>

  <div id="summary" class="panel"></div>
  <div class="panel">
    <h3>Daftar Jual</h3>
    <div id="marketList"></div>
  </div>

  <div class="panel">
    <h3>Transfer Coin</h3>
    <input id="toUser" placeholder="Nama penerima">
    <input id="amt" type="number" placeholder="Jumlah coin">
    <button id="btnTf">Kirim</button>
  </div>
</div>

<script type="module" src="js/firebase-config.js"></script>
<script type="module" src="js/online.js"></script>
<script type="module">
import { onAuth, logout, subPlayer, subMarket, buy, cancelSale, transfer } from './js/online.js';
let uid=null, me=null, unsubP=null, unsubM=null;

document.getElementById('btnLogout').onclick = ()=> logout();

function renderSummary(){
  if(!me) return;
  const p = me.pets[me.activePet] || me.pets[0];
  document.getElementById('summary').innerHTML = `
    <p><b>Player:</b> ${me.username}</p>
    <p><b>Coin:</b> ${me.coins}</p>
    <p><b>Pet Aktif:</b> Lv ${p.level} | HP ${p.hp}% | H ${p.hunger}% | E ${p.energy}%</p>
  `;
}
function renderMarket(rows){
  const box = document.getElementById('marketList');
  box.innerHTML = rows.map(r=>{
    const mine = r.sellerUid===uid;
    return `<div class="item">
      <div><b>Pet:</b> Lv ${r.pet.level} | HP ${r.pet.hp}% | H ${r.pet.hunger}% | E ${r.pet.energy}%</div>
      <div><b>Harga:</b> ${r.price} • <b>Penjual:</b> ${r.sellerName}</div>
      ${mine
        ? `<button onclick="window._cancel('${r.id}')">Batalkan</button>`
        : `<button onclick="window._buy('${r.id}')">Beli</button>`
      }
    </div>`;
  }).join('') || '<p>Tidak ada pet di marketplace.</p>';
}
window._buy = async(id)=>{ try{ await buy(uid,id); alert('Berhasil dibeli'); }catch(e){ alert(e.message);} };
window._cancel = async(id)=>{ try{ await cancelSale(uid,id); alert('Dibatalkan'); }catch(e){ alert(e.message);} };

document.getElementById('btnTf').onclick = async ()=>{
  const to = document.getElementById('toUser').value;
  const amt= document.getElementById('amt').value;
  try{ await transfer(uid,to,amt); alert('Coin terkirim'); }catch(e){ alert(e.message); }
};

onAuth(user=>{
  if(!user){ location.href='index.html'; return; }
  uid=user.uid;
  if(unsubP) unsubP(); if(unsubM) unsubM();
  unsubP = subPlayer(uid, p=>{ me=p; renderSummary(); });
  unsubM = subMarket(rows=> renderMarket(rows));
});
</script>
</body>
</html>
