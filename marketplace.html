<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marketplace — Tamagotchi</title>
<style>
body{background:#0b1220;color:#fff;font-family:system-ui,Arial;text-align:center;margin:0;padding:0}
.wrap{max-width:900px;margin:20px auto;padding:16px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
button{background:linear-gradient(180deg,#10b981,#06a77a);border:0;color:#042018;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700;margin:4px}
button.secondary{background:linear-gradient(180deg,#06b6d4,#0891b2)}
a.link{display:inline-block;background:#06b6d4;padding:8px 10px;border-radius:8px;color:#042018;text-decoration:none;margin:4px}
.item{background:#101a2b;padding:10px;border-radius:8px;margin-top:8px;text-align:left}
.small{font-size:13px;color:#9fb3b5}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h2>🛒 Marketplace</h2>
    <div class="small">Player: <strong id="playerName">—</strong> | Coin: <span id="coinText">0</span></div>

    <h3 style="margin-top:16px">Pet Dijual</h3>
    <div id="marketList" class="small muted">Loading...</div>

    <div style="margin-top:16px">
      <a class="link" href="index.html">⬅ Kembali ke Game</a>
      <a class="link" href="inventory.html">📦 Inventory</a>
      <a class="link" href="leaderboard.html">🏆 Leaderboard</a>
      <a class="link" href="chat.html">💬 Chat</a>
    </div>
  </div>
</div>

<script>
function loadPlayers(){ return JSON.parse(localStorage.getItem('players')||'{}'); }
function savePlayers(p){ localStorage.setItem('players',JSON.stringify(p)); }
function getCurrentUsername(){ return (localStorage.getItem('currentPlayer')||'').toString().trim().toLowerCase(); }
const players = loadPlayers();
const currentUsername = getCurrentUsername();
if(!currentUsername || !players[currentUsername]){
  localStorage.removeItem('currentPlayer'); location.href='login.html';
}
let currentPlayer = players[currentUsername];
document.getElementById('playerName').textContent = currentUsername;
document.getElementById('coinText').textContent = currentPlayer.coins||0;

function loadMarket(){
  return JSON.parse(localStorage.getItem('market')||'{}');
}

function renderMarket(){
  const market = loadMarket();
  const keys = Object.keys(market);
  const container = document.getElementById('marketList');
  if(keys.length===0){ container.innerHTML='<div>Tidak ada pet dijual</div>'; return; }
  container.innerHTML = '';
  keys.forEach(k=>{
    const m = market[k];
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div><strong>${m.item.name}</strong> • Lv ${m.item.level} • Seller: ${m.seller} • Price: ${m.price}💰</div>
    `;
    // if buyer
    if(m.seller !== currentUsername){
      const buyBtn = document.createElement('button'); buyBtn.textContent='Beli';
      buyBtn.onclick = ()=> buyPet(k);
      const offerBtn = document.createElement('button'); offerBtn.textContent='Tawar'; offerBtn.className='secondary';
      offerBtn.onclick = ()=> offerPet(k);
      div.appendChild(buyBtn); div.appendChild(offerBtn);
    } else {
      // seller: see offers
      if(m.offers && m.offers.length>0){
        const offersDiv = document.createElement('div'); offersDiv.className='small';
        offersDiv.innerHTML = 'Tawaran: '+ m.offers.map((o,idx)=>`<div>${o.buyer} → ${o.price}💰 <button onclick="acceptOffer('${k}',${idx})">Accept</button> <button onclick="rejectOffer('${k}',${idx})">Reject</button></div>`).join('');
        div.appendChild(offersDiv);
      }
    }
    container.appendChild(div);
  });
}

function buyPet(id){
  const market = loadMarket();
  const m = market[id];
  if(!m) return alert('Pet tidak ditemukan.');
  if(m.seller===currentUsername) return alert('Tidak bisa beli pet sendiri.');
  if(currentPlayer.coins < m.price) return alert('Coin tidak cukup.');
  currentPlayer.coins -= m.price;
  currentPlayer.inventory.push({...m.item, type:'pet'});
  delete market[id];
  localStorage.setItem('market',JSON.stringify(market));
  savePlayersObject();
  alert(`Berhasil beli pet ${m.item.name} dari ${m.seller}`);
  renderMarket();
}

function offerPet(id){
  const price = parseInt(prompt('Masukkan harga tawaran:'),10);
  if(!price || price<=0) return alert('Harga tidak valid.');
  const market = loadMarket();
  const m = market[id];
  if(!m.offers) m.offers=[];
  m.offers.push({buyer:currentUsername, price});
  localStorage.setItem('market',JSON.stringify(market));
  alert('Tawaran dikirim ke seller.');
  renderMarket();
}

function acceptOffer(id,idx){
  const market = loadMarket();
  const m = market[id];
  const offer = m.offers[idx];
  if(!offer) return;
  const buyer = players[offer.buyer];
  if(!buyer){ alert('Buyer tidak ditemukan'); return; }
  if(buyer.coins < offer.price){ alert('Buyer tidak cukup coin'); return; }
  buyer.coins -= offer.price;
  buyer.inventory.push({...m.item, type:'pet'});
  currentPlayer.coins += offer.price;
  // remove pet from market
  delete market[id];
  localStorage.setItem('market',JSON.stringify(market));
  savePlayersObject();
  alert(`Tawaran diterima! Pet dikirim ke ${offer.buyer}`);
  renderMarket();
}

function rejectOffer(id,idx){
  const market = loadMarket();
  const m = market[id];
  if(!m.offers || !m.offers[idx]) return;
  m.offers.splice(idx,1);
  localStorage.setItem('market',JSON.stringify(market));
  renderMarket();
}

function savePlayersObject(){
  const all = loadPlayers();
  all[currentUsername] = currentPlayer;
  savePlayers(all);
}

renderMarket();
</script>
</body>
</html>
