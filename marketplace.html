<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketplace â€” Tamagotchi Online</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center;padding:16px}
  .panel{background:#101a2b;border-radius:12px;padding:12px;margin:10px auto;max-width:880px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .item{background:#0f172a;border-radius:10px;padding:10px;margin:8px 0;text-align:left}
  button{background:#10b981;border:0;border-radius:8px;color:#042018;font-weight:700;padding:8px 10px;margin:4px;cursor:pointer}
  input{padding:8px;border-radius:8px;border:0;margin:4px}
  .muted{color:#a3b3c6;font-size:12px}
</style>
</head>
<body>
  <h2>ğŸª Marketplace</h2>

  <div id="authWarn" class="panel" style="display:none">
    <p>Kamu belum login.</p>
    <button onclick="location.href='index.html'">Login</button>
  </div>

  <div id="wrap" style="display:none">
    <div class="panel">
      <div class="row">
        <div>ğŸ‘¤ <span id="meEmail"></span></div>
        <div>
          <button onclick="go('index.html')">ğŸ  Home</button>
          <button onclick="go('inventory.html')">ğŸ“¦ Inventory</button>
          <button onclick="go('leaderboard.html')">ğŸ† Leaderboard</button>
          <button onclick="go('chat.html')">ğŸ’¬ Chat</button>
        </div>
      </div>
      <div>ğŸ’° Coin: <b id="coins">0</b></div>
    </div>

    <div class="panel">
      <h3>Transfer Coin ke Player</h3>
      <div class="row">
        <input id="toEmail" type="email" placeholder="Email penerima" style="min-width:240px">
        <input id="amt" type="number" placeholder="Jumlah coin">
        <button onclick="transfer()">Kirim</button>
      </div>
      <p class="muted">Transfer langsung in-game coin (gratis). Pastikan email tujuan benar.</p>
    </div>

    <div class="panel">
      <h3>Daftar Pet Dijual</h3>
      <div id="list"></div>
    </div>
  </div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyAN0GNZdIx_xPHT7MZKWJweLtNhies6QxY",
  authDomain:"tamagotchi-2be0c.firebaseapp.com",
  databaseURL:"https://tamagotchi-2be0c-default-rtdb.firebaseio.com",
  projectId:"tamagotchi-2be0c",
  storageBucket:"tamagotchi-2be0c.firebasestorage.app",
  messagingSenderId:"202052432703",
  appId:"1:202052432703:web:cb76b50e42149a2c92998a",
  measurementId:"G-TWGGSJRX26"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(), auth=firebase.auth();

let uid=null, me=null;

auth.onAuthStateChanged(async u=>{
  if(!u){ document.getElementById('authWarn').style.display='block'; return; }
  uid=u.uid; document.getElementById('wrap').style.display='block';
  document.getElementById('meEmail').innerText=u.email;

  const snap=await db.ref('users/'+uid).once('value');
  me=snap.val()||{coins:0};

  document.getElementById('coins').innerText=(me.coins||0).toFixed?.(2)||me.coins||0;
  loadListings();
});

function loadListings(){
  db.ref('marketplace/pets').on('value',snap=>{
    const list=document.getElementById('list'); list.innerHTML='';
    if(!snap.exists()){ list.innerHTML='<p class="muted">Belum ada listing.</p>'; return; }
    const data=snap.val();
    Object.values(data).sort((a,b)=>b.createdAt-a.createdAt).forEach(x=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`
        <div class="row">
          <div>
            <div>ğŸ¾ <b>${x.pet?.name||'Pet'}</b> â€” Level <b>${x.pet?.level||1}</b></div>
            <div class="muted">Penjual: ${x.sellerEmail||x.sellerUid}</div>
          </div>
          <div>
            <div>Harga: <b>${x.price}</b> coin</div>
            ${x.sellerUid!==uid?`<button onclick="buy('${x.id}')">Beli</button>`:`<button onclick="cancel('${x.id}')">Batalkan</button>`}
          </div>
        </div>`;
      list.appendChild(el);
    });
  });
}

async function buy(id){
  const ref=db.ref('marketplace/pets/'+id);
  const snap=await ref.once('value');
  if(!snap.exists()) return alert('Listing tidak ada.');
  const item=snap.val();
  if(item.sellerUid===uid) return alert('Tidak bisa beli pet sendiri.');
  const mySnap=await db.ref('users/'+uid).once('value');
  const buyer=mySnap.val()||{};
  if((buyer.coins||0)<item.price) return alert('Coin tidak cukup.');

  // transaksi sederhana (non-atomic demo)
  buyer.coins = (buyer.coins||0)-item.price;
  buyer.inventory = buyer.inventory||{};
  const invId = 'P'+Date.now();
  buyer.inventory[invId]=item.pet;

  const sellerSnap=await db.ref('users/'+item.sellerUid).once('value');
  const seller=sellerSnap.val()||{};
  seller.coins=(seller.coins||0)+item.price;

  await db.ref('users/'+uid).set(buyer);
  await db.ref('users/'+item.sellerUid).set(seller);
  await ref.remove();

  alert('Pembelian berhasil. Pet masuk ke Inventory.');
  location.reload();
}

async function cancel(id){
  const ref=db.ref('marketplace/pets/'+id);
  const snap=await ref.once('value');
  if(!snap.exists()) return;
  const item=snap.val();
  if(item.sellerUid!==uid) return alert('Bukan milikmu.');
  // kembalikan ke inventory
  const mySnap=await db.ref('users/'+uid).once('value');
  const me=mySnap.val()||{};
  me.inventory = me.inventory||{};
  me.inventory['P'+Date.now()]=item.pet;
  await db.ref('users/'+uid).set(me);
  await ref.remove();
}

async function transfer(){
  const email=document.getElementById('toEmail').value.trim();
  const amt=parseFloat(document.getElementById('amt').value);
  if(!email||!amt||amt<=0) return alert('Isi email & jumlah.');
  if(amt>(me.coins||0)) return alert('Coin kamu tidak cukup.');

  // cari uid target lewat profiles (disarankan Anda menyimpan profiles saat register/login)
  const prof=await db.ref('profiles').once('value');
  let targetUid=null;
  if(prof.exists()){
    const ps=prof.val();
    for(const k in ps){ if(ps[k].email===email){ targetUid=k; break; } }
  }
  if(!targetUid) return alert('Email penerima tidak ditemukan (belum pernah login).');

  const targetSnap=await db.ref('users/'+targetUid).once('value');
  const target=targetSnap.val()||{};

  me.coins=(me.coins||0)-amt;
  target.coins=(target.coins||0)+amt;

  await db.ref('users/'+uid).set(me);
  await db.ref('users/'+targetUid).set(target);

  alert('Transfer sukses!');
  location.reload();
}

function go(p){ location.href=p; }
</script>
</body>
</html>
