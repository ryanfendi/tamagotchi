<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Marketplace ‚Äî Tamagotchi</title>
<style>
  body{background:#0b1220;color:#fff;font-family:sans-serif;text-align:center}
  .panel{background:#101a2b;padding:10px;margin:10px auto;width:90%;max-width:600px;border-radius:8px}
  button{background:#10b981;border:none;padding:8px;margin:4px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer}
  input{padding:6px;margin:4px;border-radius:6px;border:none}
  .list-item{background:#1a2436;padding:8px;margin:6px;border-radius:8px}
</style>
</head>
<body>
<!-- Proteksi -->
<script>
  (function(){
    const current = localStorage.getItem('currentPlayer');
    if(!current){ alert('Silakan login terlebih dahulu'); location.href='login.html'; return; }
    const players = JSON.parse(localStorage.getItem('players')||'{}');
    if(!players[current]){ localStorage.removeItem('currentPlayer'); alert('Akun tidak ditemukan. Silakan login kembali.'); location.href='login.html'; }
  })();
</script>

<h2>üõí Marketplace</h2>
<div style="margin-bottom:8px;">
  <button onclick="goTo('index.html')">üè† Home</button>
  <button onclick="goTo('inventory.html')">üì¶ Inventory</button>
  <button onclick="goTo('leaderboard.html')">üèÜ Leaderboard</button>
  <button onclick="goTo('chat.html')">üí¨ Chat</button>
</div>

<div id="marketList" class="panel">Memuat...</div>

<div id="ownerPanel" class="panel" style="display:none;">
  <h3>OWNER MENU</h3>
  <p>Jual pet baru:</p>
  <input id="newPetName" placeholder="Nama Pet Baru">
  <input id="newPetPrice" type="number" placeholder="Harga">
  <button onclick="ownerSell()">Tambahkan ke Marketplace</button>
</div>

<script>
let players = JSON.parse(localStorage.getItem('players')||'{}');
let market  = JSON.parse(localStorage.getItem('market')||'{}');
const current = localStorage.getItem('currentPlayer');
let currentPlayer = players[current];

const OWNER_USERNAME = 'owner';
if(currentPlayer.username === OWNER_USERNAME) document.getElementById('ownerPanel').style.display = 'block';

function saveAll(){
  players[current] = currentPlayer;
  localStorage.setItem('players', JSON.stringify(players));
  localStorage.setItem('market', JSON.stringify(market));
}
function goTo(p){ location.href=p; }

function renderMarket(){
  const div = document.getElementById('marketList');
  div.innerHTML = '<h3>Daftar Pet Dijual</h3>';
  const keys = Object.keys(market);
  if(keys.length===0){ div.innerHTML += '<p>Tidak ada pet di marketplace.</p>'; return; }
  keys.forEach(id=>{
    const item = market[id];
    div.innerHTML += `
      <div class="list-item">
        <b>${item.pet.name||'Pet'}</b> (Level ${item.pet.level||1})<br>
        Harga: ${item.price} coin<br>
        Penjual: ${item.seller}<br>
        <button onclick="buy('${id}')">Beli</button>
        <input id="offer${id}" type="number" placeholder="Tawar harga">
        <button onclick="offer('${id}')">Tawar</button>
      </div>
    `;
  });
}

function buy(id){
  const item = market[id];
  if(!item) return;
  if(currentPlayer.coins < item.price) return alert('Coin tidak cukup!');
  currentPlayer.coins -= item.price;
  currentPlayer.inventory.push(item.pet);
  delete market[id];
  saveAll();
  alert('Pembelian berhasil!');
  renderMarket();
}

function offer(id){
  const price = parseInt((document.getElementById('offer'+id).value||'').toString(),10);
  if(!price || price<=0) return alert('Harga tidak valid');
  if(!market[id]) return alert('Item tidak ditemukan');
  market[id].offers.push({buyer: currentPlayer.username, price});
  localStorage.setItem('market', JSON.stringify(market));
  alert('Penawaran dikirim!');
}

function ownerSell(){
  const name = (document.getElementById('newPetName').value||'').trim();
  const price = parseInt((document.getElementById('newPetPrice').value||'').toString(),10);
  if(!name || !price) return alert('Isi semua kolom');
  const id = 'sale_'+Date.now();
  market[id] = { seller: 'owner', pet: { name, level:1 }, price, offers: [] };
  localStorage.setItem('market', JSON.stringify(market));
  alert('Pet ditambahkan!');
  renderMarket();
}

renderMarket();
</script>
</body>
</html>
